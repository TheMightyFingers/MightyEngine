'use strict';(function(){function T(a,b){function d(){}d.prototype=a;var c=new d,e;for(e in b)c[e]=b[e];b.toString!==Object.prototype.toString&&(c.toString=b.toString);return c}function v(a,b){if(null==b)return null;null==b.__id__&&(b.__id__=X++);var d;null==a.hx__closures__?a.hx__closures__={}:d=a.hx__closures__[b.__id__];null==d&&(d=function(){return d.method.apply(d.scope,arguments)},d.scope=a,d.method=b,a.hx__closures__[b.__id__]=d);return d}var E=function(){return z.Boot.__string_rec(this,"")},
n=function(){};n.__name__=!0;n.convertToMp3=function(a,b,d){null==b&&(b=n.getBaseName(a)+".mp3");c.debug("converting sound",a,b);c.path.resolve(a)==c.path.resolve(b)?(null!=d&&d(),c.debug("Skipped MP3")):(a="-y -i "+q.shellEscape(a)+" "+q.shellEscape(b),n.exec(a,d))};n.getErrors=function(){var a=n.errors;n.errors=[];return a};n.convertToM4a=function(a,b,d){null==b&&(b=n.getBaseName(a)+".m4a");c.path.resolve(a)==c.path.resolve(b)?null!=d&&d():(a="-y -i "+q.shellEscape(a)+" -strict -2 -vn "+q.shellEscape(b),
n.exec(a,d))};n.convertToOgg=function(a,b,d){null==b&&(b=n.getBaseName(a)+".ogg");c.path.resolve(a)==c.path.resolve(b)?null!=d&&d():(a="-y -i "+q.shellEscape(a)+" -acodec libvorbis "+q.shellEscape(b),n.exec(a,d))};n.convertToWav=function(a,b,d){null==b&&(b=n.getBaseName(a)+".wav");c.path.resolve(a)==c.path.resolve(b)?null!=d&&d():(a="-y -i "+q.shellEscape(a)+" "+q.shellEscape(b),n.exec(a,d))};n.convertToExt=function(a,b,d,f){"mp3"==b?n.convertToMp3(a,d,f):"ogg"==b?n.convertToOgg(a,d,f):"wav"==b?n.convertToWav(a,
d,f):"m4a"==b?n.convertToM4a(a,d,f):(c.debug("unknown format",b),null!=f&&f())};n.isSoundFile=function(a){a=c.path.extname(a);return".mp3"==a||".ogg"==a||".m4a"==a||".wav"==a};n.getBaseName=function(a){return c.path.dirname(a)+c.path.sep+c.path.basename(a,c.path.extname(a))};n.exec=function(a,b){var d=c.path.resolve("bin/audio");c.cfg.ffmpegPath&&c.cfg.ffmpegPath&&(d=c.path.resolve(c.cfg.ffmpegPath));c.child.exec(d+" "+a,function(a){null!=a&&(c.debug("Sound -> exec error: "+a),n.errors.push("Audio exec: "+
a));null!=b&&b()})};var Q=function(a,b,d,f){this.serverPluginChanges=null;this.useTimestamp=this.useSocket=!1;this.engineIncludesFile="engine/LoaderIncludes.js";this.releaseMode=!1;this.project=a;this.editor=f;this.cbx=d;this.project.isBroken()?(c.debug("Failed deploy","Broken project"),this.cb()):(this.report={errors:"",warnings:"",info:"",closureReport:"",release:""},this.options=b,this.branchId=b.branch,this.projectPath=a.getPath(),this.path=this.projectPath+"/"+i.string(c.cfg.project.paths.deploy)+
"/"+i.string(this.branchId),a=this.projectPath+"/"+i.string(c.cfg.project.paths.release)+"/"+b.name,null!=b.releasePath&&""!=b.releasePath&&c.fs.existsSync(b.releasePath)&&(a=b.releasePath+"/"+b.name),this.releasePath=a,this.resourcePath=this.path+"/default",this.engineIncludesFile=this.projectPath+"/"+this.engineIncludesFile,c.fs.existsSync(this.projectPath+"/engine/MightyLoader.js")&&(this.releaseMode=!0),this.genPluginPaths(),c.fs.exists(this.path,v(this,this.checkDirs)))};Q.__name__=!0;Q.prototype=
{zipFiles:function(a){c.mkzip(this.releasePath+i.string(c.path.sep)+i.string(this.options.name)+".zip",this.releasePath,a)},execDeployHook:function(a,b,d){var f=this,e=c.path.resolve(a);c.exec(e,[this.project.name,this.project.getBranchName(this.branchId),this.options.name],function(a,b){f.report.errors+="script: "+e+" error: "+a+"\r\n"+b+"\r\n";d()},b)},runScript:function(a,b){null==b&&(b=0);var d=this;if(!this.options.script||""==this.options.script)null!=a&&a();else{var f;f={cwd:this.releasePath+
"/",env:process.env};var e=this.options.script;"/"!=e.substring(0,1)?b==c.cfg.deployHooksPaths.length?(this.report.errors+="Failed to exec: "+i.string(this.options.script)+": NOT FOUND",a()):(e=this.projectPath+"/"+c.cfg.deployHooksPaths[b]+"/"+i.string(this.options.script),c.fs.exists(e,function(c){c?d.execDeployHook(e,f,a):(b++,d.runScript(a,b))})):this.execDeployHook(e,f,a)}},parseIndex:function(a,b,d){if(null!=a)c.debug("Deploy::parseIndex -> error reading file",a);else{a="";this.useTimestamp&&
(a="?"+q.getTime());var b=q.splitInLines(b),f="",e="fullSources";this.options.useClosureCompiler&&(e="full.min");var g="";this.options.cocoonJS&&(g='<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS.js"><\/script>\r\n<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS_App.js"><\/script>\r\n<script type="text/javascript" src="engine/library/CocoonJSExtensions/CocoonJS_App_ForCocoonJS.js"><\/script>\r\n');for(var k="",j=0;j<b.length;)if(k=b[j],
++j,!(-1<k.indexOf("engine/library/editor.js")))if(-1<k.indexOf("</head>"))f+=g+"\r\n"+i.string(k)+"\r\n";else if(!((!this.useSocket||this.options.cocoonJS)&&-1<k.indexOf("/socket.io/socket.io.js"))&&!(-1<k.indexOf("debug.js")))k=k.replace(".css",".css"+a).replace("engine/init.js",e+".js"+a).replace("engine/MightyLoader.js",e+".js"+a),f+=i.string(k)+"\r\n";c.fs.writeFile(this.releasePath+"/index.html",f,"utf-8",function(a){null==a&&null!=d&&d()})}},copySources:function(a,b,d){null==b&&(b=0);var f=
this;if(b>=a.length)null!=d&&d();else{var e=this.projectPath+a[b],g=this.releasePath+a[b],k=c.path.resolve(this.projectPath+i.string(c.path.sep)+i.string(c.cfg.deployPath));h.copy(e,g,function(){f.copySources(a,++b,function(){d()})},function(a,b,d){return!(d.isDirectory()&&c.path.resolve(a)==k)})}},minimizeSources:function(a,b){var d=this,f=c.require(b).paths;h.rm(this.releasePath,function(){var b=new I(3,function(){d.cb()});d.copySources(f,0,v(b,b.done));c.fs.readFile(d.projectPath+"/index.html",
"utf-8",function(a,c){d.parseIndex(a,c,v(b,b.done))});a=a.split('"use strict";').join("");c.fs.writeFile(d.releasePath+"/fullSources.js","var global = {};window.gParams = {release: true, rel: true};\r\n"+i.string(a)+"\r\n","utf-8",function(a){a&&c.debug("Deploy::minimizeSources -> fullSources.js -> error",a);d.report.release=c.path.resolve(d.releasePath);if(d.options.useClosureCompiler){b.add();try{c.child.exec("java -jar bin/compiler.jar  --language_in "+i.string(d.options.closureCompiler.language_in)+
" --compilation_level "+i.string(d.options.closureCompiler.compilation_level)+" "+i.string(d.options.closureCompiler.compilerFlags)+" --js "+d.releasePath+"/fullSources.js  --js_output_file "+d.releasePath+"/full.min.js ",function(a,b,f){c.debug("stdout: "+b);c.debug("stderr: "+f);null!=a&&c.debug("compilation done with errors");""!=f&&(d.report.closureReport+=""+f+"\r\n");""!=b&&(d.report.closureReport+="Info: "+f+"\r\n")}).on("close",function(){null!=d.editor&&d.editor.emit("deployCompleted",d.report);
b.done()})}catch(f){c.debug("Deploy::Closure compiler Failed",a)}}});h.copy(d.path,d.releasePath+"/assets/deploy",v(b,b.done))},!0)},checkProject:function(a){var b=this,d=this.projectPath+i.string(c.path.sep)+i.string(c.cfg.project.paths.editor)+i.string(c.path.sep)+i.string(c.cfg.project.configFile),f=c.cfg.newProjectTemplates+c.path.sep+c.cfg.defaultProjectTemplate+c.path.sep+c.cfg.project.paths.editor+c.path.sep+c.cfg.project.configFile;c.fs.exists(d,function(e){e?b.minimizeSources(a,d):h.copy(f,
d,function(e){e?c.debug("Failed to locate",e,f):b.minimizeSources(a,d)})})},prepareSources:function(a){var b=this;c.fs.exists(this.releasePath,function(d){d?b.checkProject(a):h.mkdir(b.releasePath,function(){b.checkProject(a)})})},parseIncludes:function(a,b,d){null==b&&(b="");var f=this;if(this.releaseMode){for(var e=0;e<a.length;){var g=a[e];++e;b+="//"+this.projectPath+"/"+g+"\r\n"+i.string(c.fs.readFileSync(this.projectPath+i.string(c.path.sep)+g,"utf-8"))+"\r\n"}d(b)}else c.fs.readFile(this.engineIncludesFile,
"utf-8",function(e,g){if(e)c.debug("Deploy: Failed to parse Includes",e);else{for(var h=q.splitInLines(g),m="",t="",s="",x=0;x<h.length;)s=h[x],++x,s=s.trim(),0==s.indexOf('loader.rootPath = "')?m=s.substring(19,s.lastIndexOf('"')):0==s.indexOf('loader.path = "')?t=s.substring(15,s.lastIndexOf('"')):0==s.indexOf('loader.include("')&&(s=s.substring(16,s.lastIndexOf('");')),s=m+t+s,b+="//"+f.projectPath+"/"+s+"\r\n"+i.string(c.fs.readFileSync(f.projectPath+i.string(c.path.sep)+s,"utf-8"))+"\r\n");for(x=
0;x<a.length;)h=a[x],++x,b+="//"+f.projectPath+"/"+h+"\r\n"+i.string(c.fs.readFileSync(f.projectPath+i.string(c.path.sep)+h,"utf-8"))+"\r\n";d(b)}})},readBaseIncludes:function(a,b,d,f){var e=this;b>a.length-1?(this.releaseMode?c.debug("Deploy::REALEASE mode"):c.debug("Deploy::DEBUG mode"),f(d)):c.fs.readFile(a[b],"utf-8",function(g,k){null!=g?c.debug("Cannot find include: ",g):(d+=k,e.readBaseIncludes(a,++b,d,f))})},loadBaseIncludes:function(a,b){null==b&&(b="");for(var d=[],f=c.cfg.includes.core,
e=0;e<f.length;){var g=f[e];++e;d.push(this.path+g)}f=this.releaseMode?c.cfg.includes.release:c.cfg.includes.debug;for(e=0;e<f.length;)g=f[e],++e,d.push(this.projectPath+g);this.readBaseIncludes(d,0,b,a)},deployIncludes:function(a){var b=this,d='(mighty.Loader.path = (window.gParams.gPath ? window.gParams.gPath : ""));\r\n(function(){\r\nvar loader = mighty.Loader;\r\n',f=c.path.resolve(this.projectPath);c.debug("PROJECT path",f);for(var e=[],g=c.cfg.project.paths.editor,k=0;k<a.length;){var j=a[k];
++k;if(-1==j.indexOf(f)){var B=c.path.basename(j),m=g+"/share/"+B,B=f+i.string(c.path.sep)+g+i.string(c.path.sep)+"share"+i.string(c.path.sep)+B;h.copy(j,B,null);j=m;c.debug("filePath web",j)}else j=j.substring(f.length+1),c.debug("filepath",j);j=j.split("\\").join("/");d+='loader.include("'+j+'");\r\n';e.push(j)}c.fs.writeFile(this.path+i.string(c.path.sep)+"includes.js",d+"})();\r\n","utf-8");this.options.full?this.loadBaseIncludes(function(a){b.parseIncludes(e,a,v(b,b.prepareSources))}):this.cb()},
scanPlugins:function(a,b,d,c,e){var g=this;d==a.length?c(b,this.branchId):h.scanDir(a[d],function(){d++;g.scanPlugins(a,b,d,c,e)},e)},collectIncludes:function(a,b,d){var f=this,e=new A(".*\\.js$",""),g=new A(".*\\.editor\\.js$",""),k=new A(".*\\.editorPlugin\\.js$",""),j=[],h=b.Deploy.palette;this.scanPlugins(this.pluginsPaths,j,0,d,function(a,b,d){if(d.isDirectory()){for(var d=0,i=f.pluginsPaths.length;d<i;){var p=d++;if(c.path.resolve(b)==p){for(b=0;b<h.length;)if(d=h[b],++b,d.name==a)return d.disabled?
(c.debug("Deploy::filterPlugins -> Disabled plugin/addon",d),!1):!0;c.debug("Deploy::filterPlugins -> unknown plugin:",a);break}}return!0}if(g.match(a)||k.match(a))return!1;e.match(a)&&j.push(b);return!1})},checkResources:function(a,b,d,f,e){c.fs.exists(b,function(c){c?h.cp(b,d+"."+f,e):n.convertToExt(a,f,b,function(){h.cp(b,d+"."+f,e)})})},deployResource:function(a,b,d,f){d=this.project.getPrivatePath();switch(b){case "Texture":null!=a.img&&null==a.image&&(a.image=a.img);var b=d+"/upload/"+a.image,
e=c.fs.statSync(b);a.ext=c.getExt(a.image);a.date=e.mtime.getTime();h.cp(b,this.resourcePath+"/img/"+a.id+"."+a.ext,f);delete a.image;break;case "Sound":null!=a.snd&&null==a.sound&&(a.sound=a.snd);b=d+"/upload/"+a.sound;d=n.getBaseName(b);e=c.fs.statSync(b);a.ext=c.getExt(a.sound);a.date=e.mtime.getTime();delete a.sound;if(!this.options.full){h.cp(b,this.resourcePath+"/snd/"+a.id+"."+a.ext,f);break}if(!this.options.audio){f();break}var g=0,e=function(){g--;0==g&&f()},a=this.resourcePath+"/snd/"+a.id;
this.options.audio.mp3&&(g++,this.checkResources(b,d+".mp3",a,"mp3",e));this.options.audio.ogg&&(g++,this.checkResources(b,d+".ogg",a,"ogg",e));this.options.audio.m4a&&(g++,this.checkResources(b,d+".m4a",a,"m4a",e));this.options.audio.wav&&(g++,this.checkResources(b,d+".wav",a,"wav",e));a=n.getErrors();if(0<a.length){b=0;for(d=a.length;b<d;)e=b++,this.report.errors+="\r\n"+a[e]+"\r\n"}break;default:b=d+"/upload/"+a.file,e=c.fs.statSync(b),a.ext=c.getExt(a.file),a.date=e.mtime.getTime(),h.cp(b,this.resourcePath+
"/img/"+a.id+"."+a.ext,f),delete a.file}},addTemplates:function(a,b){if(this.options.full){null==a.Resource.Templates&&(a.Resource.Templates={});var d=function(b,d,f){if(f.isDirectory()){f="";c.fs.existsSync(d+"/"+b+".js")&&(f=c.fs.readFileSync(d+"/"+b+".js","utf-8"));var j="";c.fs.existsSync(d+"/"+b+".html")&&(j=c.fs.readFileSync(d+"/"+b+".html","utf-8"));a.Resource.Templates[b]={js:f,html:j}}return!1};try{h.scanDir(this.projectPath+"/src/templates",b,d)}catch(f){this.report.errors+="template: "+
this.projectPath+"/src/templates failed with error: "+i.string(f)+"\r\n"}}else b()},deployItems:function(a,b){var d=this,f=Object.keys(a),e,g=this.project.getPluginsType(),k=this.project.getAddonsType(),j=q.clone(b);null==j.Resource?j.Resource={Templates:{}}:j.Resource.Templates={};var h,m,t=new I(1,function(){for(var a=Object.keys(j),b="",f=0;f<a.length;){var e=a[f];++f;"string"!=q.getType(e)?c.debug("Deploy->library: error",e):"[object Object]"==e?c.debug("Deploy->library: error",j):"Addon"!=e&&
(b+="var "+i.string(e)+" = window."+i.string(e)+" = "+JSON.stringify(j[e],null,"\t")+";\r\n")}c.fs.writeFile(d.path+"/library.js",b,"utf-8",function(){d.collectIncludes(d.branchId,j,v(d,d.deployIncludes))})});j.Plugin||(j.Plugin={});j.Resource||(j.Resource={});j.Plugin.palette||(j.Plugin.palette=[]);j.Deploy||(j.Deploy={});j.Deploy.palette||(j.Deploy.palette=[]);for(var s=0;s<f.length;)if(e=f[s],++s,m=this.project.resolveEnums(a[e],b),e=m.editor,delete m.editor,h=e.plugin||e.type)if(m.group=e.group,
h==g)"Resource"==m.name&&(this.useTimestamp=m.useTimestamp),"Server"==m.name&&(this.serverPlugin=m,this.options.cocoonJS&&(this.serverPluginChanges={offlineMode:m.offlineMode},m.offlineMode=!0),this.useSocket=m.useSocket,m.offlineMode&&(this.useSocket=!1)),j[m.name]||(j[m.name]={}),j[m.name].Cfg=m,"Core"!=e.origin&&(j.Plugin.palette.push(m.name),j.Deploy.palette.push(m));else if(h==k)"Core"!=e.origin&&j.Deploy.palette.push(m);else if("Deploy"!=h){if("Resource"==h){t.add();try{this.deployResource(m,
e.type,this.resourcePath,v(t,t.done))}catch(x){c.debug("DEPLOY -> ERROR deployResource",m);this.report.errors+="resource: ("+i.string(e.type)+")"+i.string(m.name)+" failed: "+i.string(x.toString())+"\r\n";t.done();continue}}m.skip||(j[h]?j[h].palette||(j[h].palette=[]):j[h]={palette:[]},j[h].palette.push(m))}t.add();this.addTemplates(j,v(t,t.done));t.done()},getIncludes:function(){var a=this;this.project.getImport(function(b,d,c){a.project.getAllItems(a.branchId,function(b){a.deployItems(b,c)})})},
mkdirs:function(){var a=this;c.fs.exists(this.resourcePath,function(b){b?a.getIncludes():a.cb()})},checkDirs:function(a){var b=this,d=new I(0,v(this,this.mkdirs));a?h.rm(this.path,function(){c.fs.exists(b.resourcePath,function(){});d.add(2);h.mkdir(b.resourcePath+"/img",function(){c.fs.mkdir(b.resourcePath+"/snd",v(d,d.done));c.fs.mkdir(b.resourcePath+"/res",v(d,d.done))})},!0):(d.add(2),h.mkdir(this.resourcePath+"/img",function(){c.fs.mkdir(b.resourcePath+"/snd",v(d,d.done));c.fs.mkdir(b.resourcePath+
"/res",v(d,d.done))}))},genPluginPaths:function(){var a=[],b;b=c.cfg.pluginsPaths;for(var d=0;d<b.length;){var f=b[d];++d;a.push(c.path.resolve(f.path))}b=c.cfg.addonsPaths;for(d=0;d<b.length;)f=b[d],++d,a.push(c.path.resolve(f.path));b=c.cfg.project.paths.plugins;for(d=0;d<b.length;)f=b[d],++d,a.push(c.path.resolve(this.projectPath+i.string(c.path.sep)+i.string(f.path)));b=c.cfg.project.paths.addons;for(d=0;d<b.length;)f=b[d],++d,a.push(c.path.resolve(this.projectPath+i.string(c.path.sep)+i.string(f.path)));
this.pluginsPaths=a},cb:function(){var a=this;null!=this.serverPluginChanges&&(this.serverPlugin.offlineMode=this.serverPluginChanges.offlineMode);this.project.emitAll("deployDone",null);c.debug("Deploy:: Deploy DONE!",this.options);null!=this.options&&this.options.full?this.runScript(function(){a.options.zipFiles?a.zipFiles(function(){a.cbx(a.report)}):a.cbx(a.report)}):this.cbx(this.report)},__class__:Q};var L=function(a,b,d){null==d&&(d=!1);this.isStopping=!1;this.cbx=b;c.debug("custom watcher - started");
this.dir=a;this.oldFiles={};this.collectFiles(a);this.forceUpdate=d};L.__name__=!0;L.prototype={stop:function(){console.log("DirWatcher stopped");this.isStopping=!0;if(null!=this.watchers)for(var a=0,b=this.watchers;a<b.length;){var d=b[a];++a;d&&d.close()}},cb:function(a,b,d){this.isStopping||this.cbx(a,b,d)},pollingTimeout:function(){var a=this;this.isStopping||r.Timer.delay(function(){a.collectFiles(a.dir);a.forceUpdate&&a.cb(null,null,null)},c.cfg.watcherPollingTime)},compareFiles:function(a){var b=
Object.keys(a),d=Object.keys(this.oldFiles);if(b.length!=d.length)c.debug("Watcher::FS changed:","file count not match"),this.cb(null,null,null);else for(var f=d=null,e=0;e<b.length;){var g=b[e];++e;d=a[g];f=this.oldFiles[g];if(null==d||null==f){c.debug("Watcher::FS changed: no stats for file - deleted?:",g);delete a[g];delete oldFiles[g];this.cb(null,null,null);this.pollingTimeout();return}if(d.mtime.getTime()!=f.mtime.getTime()){c.debug("Watcher::FS changed: ",g);this.cb(g,d,d);this.oldFiles=a;
this.pollingTimeout();return}}this.oldFiles=a;this.pollingTimeout()},collectFiles:function(a){var b=this,d={};h.scanDir(a,function(){b.compareFiles(d)},function(a,b,c){return!c?!1:h.filterJsFiles(a,b,c)||c.isDirectory()?(d[b]=c,!0):!1})},__class__:L};var M=function(a,b){b.writeHead(404);b.end()};M.__name__=!0;M.prototype={__class__:M};var A=function(a,b){b=b.split("u").join("");this.r=RegExp(a,b)};A.__name__=!0;A.prototype={match:function(a){this.r.global&&(this.r.lastIndex=0);this.r.m=this.r.exec(a);
this.r.s=a;return null!=this.r.m},__class__:A};var F=function(a){var b=this;this.socket=a;this.emitData={action:null,data:null};this.rooms=[];this.socket.on("action",function(a,c){var e=b.action(a.action,a.data,c);null!=e&&null!=c&&c(e)})};F.__name__=!0;F.emitAllStatic=function(a,b,d){a={action:a,data:b};c.io.sockets["in"](d).emit("action",a)};F.prototype={emitAll:function(a,b){for(var d=0,f=this.rooms;d<f.length;){var e=f[d];++d;this.emitData.action=a;this.emitData.data=b;c.io.sockets["in"](e).emit("action",
this.emitData)}},emit:function(a,b){this.emitData.action=a;this.emitData.data=b;this.socket.emit("action",this.emitData)},leaveAllRooms:function(){for(var a=0,b=this.rooms;a<b.length;){var d=b[a];++a;this.leaveRoom(d)}},leaveRoom:function(a){u.remove(this.rooms,a);this.socket.leave(a)},joinRoom:function(a){for(var b=0,d=this.rooms;b<d.length;){var c=d[b];++b;if(c==a)return}this.rooms.push(a);this.emitAll("room joined","new participiant");this.socket.join(a)},action:function(a,b,d){var f=w.field(this,
"a_"+a);if(w.isFunction(f))return f.apply(this,[b,d]);this.emit("FIXME",[a,b]);c.debug("Not an action function",a);null!=d&&d();return null},__class__:F};var N=function(a){var b=this;F.call(this,a);this.emit("setDemo",c.cfg.demoMode);C.addAction("uploadBg",{start:function(a){var f=new G(b.project,null,null,b),f=i.string(c.cfg.projectsPath)+"/"+i.string(a.project)+"/src/templates/"+f.normalizeName(a.template_name)+"/";if(null!=a.prev_bg_image)try{c.fs.unlinkSync(f+y.urlDecode(a.prev_bg_image))}catch(e){}c.fs.existsSync(f)||
c.fs.mkdirSync(f);f+="img/";c.fs.existsSync(f)||c.fs.mkdirSync(f);return f},finish:function(a,b){var c=a.split("/"),g=c.slice();g.splice(0,c.length-2);c.splice(0,c.length-5);c={success:!0,file:g.join("/"),path:c.join("/")};b.write(r.Json.stringify(c));b.end()}})};N.__name__=!0;N.__super__=F;N.prototype=T(F.prototype,{a_scripts:function(a,b){b()},a_export:function(a,b){c.debug("EXPORT called");this.project["export"](function(a){b(a)})},a_uiGetNormalName:function(a,b){if(!(null==a||null==a.name)){var d=
new G(this.project,a,b,this);b({normal_name:d.normalizeName(a.name)})}},a_uiRemoveFile:function(a,b){(new G(this.project,a,b,this)).removeFile()},a_deleteUITemplate:function(a,b){(new G(this.project,a,b,this)).deleteUITemplate()},a_generateHtml:function(a,b){(new G(this.project,a,b,this)).generateHtml()},a_deploy:function(a,b){null!=this.project&&this.project.deploy(a,b,this)},a_delBranch:function(a,b){this.project.deleteBranch(a.id,b)},a_setBranch:function(a,b){this.project.setBranch(a,b)},a_getBranchesTree:function(a,
b){this.project.getBranchesTree(a.branch,b)},a_del:function(a,b){a.id?this.project.delItem(a,function(){null!=b&&b()}):c.debug("Editor::a_del -> Delete unknown item",a)},a_set:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.setItem(a,function(a){b(a)});return null},a_get:function(a,b){if(null==this.project)return{_error:"Not a project"};this.project.getItems(a,b);return null},a_del_project:function(a){var b=this;p.rmProject(a.name,function(){h.rm(i.string(c.cfg.projectsPath)+
"/"+i.string(a.name),function(){b.a_get_projects(null,function(a){0<a.length?b.emitAll("setProject",a[0]):b.createNewProject("demo",function(){b.emitAll("setProject","demo")})})})})},a_getSourceTree:function(a,b){var d=this;if(null==this.project)return{_error:"Not a project"};var f={};h.scanDir(this.project.getPath()+i.string(c.path.sep)+"src",function(a){a.push(d.project.getPath()+i.string(c.path.sep)+"index.html");h.collectSources(a,function(a){b({map:a,all:f})})},function(a,b,d){f[b]=d;f[b].isDir=
d.isDirectory();return h.filterProjectFiles(a,b,d)})},a_saveFile:function(a,b){var d=c.path.resolve(a.fileName);a.isFolder?h.mkdir(a.fileName,b):c.fs.writeFile(d,a.data,function(a){b(a)})},a_getUserScripts:function(a,b){if(null==this.project)return{_error:"Not a project"};h.scanDir(this.project.getPath(),function(a){b(a)},h.filterEditorPlugins)},createProjectDone:function(a,b,d){null!=a&&c.debug("Editor::NewProject engine sources failed",a);null!=d&&d()},createProjectCopy:function(a,b){var d=this;
h.copy(c.cfg.engine.srcPath,i.string(c.cfg.projectsPath)+"/"+a+"/engine",function(c){d.createProjectDone(c,a,b)})},createProjectSymlink:function(a,b){var d=this;c.fs.symlink(c.cfg.engine.srcPath,i.string(c.cfg.projectsPath)+"/"+a+"/"+i.string(c.cfg.project.paths.engine),"junction",function(f){null!=f?(c.debug("Warning: symlink failed, proceeding with copy"),d.createProjectCopy(a,b)):d.createProjectDone(null,a,b)})},checkEngineAndLaunch:function(a,b){var d=this;c.fs.exists(c.cfg.projectsPath+c.path.sep+
a+c.path.sep+c.cfg.project.paths.engine,function(f){f?b():(c.debug(i.string(c.cfg.projectsPath)+"/"+a+"/"+i.string(c.cfg.project.paths.engine)),d.addEngine(a,b))})},addEngine:function(a,b){c.debug("ADDING ENGINE:"+a);c.cfg.useSymlinks?this.createProjectSymlink(a,b):this.createProjectCopy(a,b)},createNewProject:function(a,b){var d=this;h.copy(c.cfg.newProjectTemplates+c.path.sep+c.cfg.defaultProjectTemplate,i.string(c.cfg.projectsPath+c.path.sep)+a,function(){d.addEngine(a,b)})},a_new_project:function(a,
b){var d=this;""==a.name?(this.emit("error","badName "+i.string(a.name)),b({error:1})):this.a_get_projects(null,function(f){for(var e=0;e<f.length;){var g=f[e];++e;if(g==a.name){d.emit("error","project exists "+i.string(a.name));b({error:1});return}}c.debug("NewProject::creating","about to copy");d.createNewProject(a.name,b)})},a_get_projects:function(a,b){var d=[];h.scanDirShallow(c.cfg.projectsPath,function(){b(d)},function(a,b,c){c&&c.isDirectory()&&d.push(a);return!0})},a_testItems:function(a,
b){this.project.checkAllItems(b)},a_getAllItems:function(a,b){null==a&&(a={branch:1});this.project.getAllItems(a.branch,function(a){b(a)})},a_setProject:function(a){var b=this;!a||""==a?c.debug("WTF"):(this.projectName=a,this.checkEngineAndLaunch(a,function(){b.leaveAllRooms();b.joinRoom(a);p.newProject(a,function(a){b.project=a;b.project.getImport(function(a,d){b.emit("updateImport",{Import:a,ImportDef:d});var g=null;c.debug("gamePort!!!");var k=function(){c.debug("Editor::updatePort:"+b.project.getName());
var a=b.project.getPort();0==a?g():b.emit("updateGamePort",a)},g=function(){r.Timer.delay(k,1E3)};k()})})}))},__class__:N});var c=function(){var a=c.http.createServer(v(this,this.response));a.listen(c.cfg.port,c.cfg.host);a.on("error",function(a){c.debug("Server::Error",a)});try{this.initSocket(a,v(this,this.onSocketReady))}catch(b){c.debug("Server::SOCKET error",b)}c.callbacks=[]};c.__name__=!0;c.require=function(a){return require(a)};c.initModules=function(){c.http=c.require("http");c.fs=c.require("fs");
c.sio=c.require("socket.io");c.path=c.require("path");c.sys=c.require("util");c.child=c.require("child_process");c.domain=c.require("domain");c.os=c.require("os");c["const"]={EEXIST:47};c.mkzip=c.mkzipN;c.unzip=c.unzipN;process.env.PATH=c.path.resolve("./bin")+c.path.delimiter+process.env.PATH;c.debug(process.env.PATH)};c.main=function(a){c.initModules();var b;try{b=c.require("./config.js").config}catch(d){c.debug("reading config failed, continue with default config",d),b=c.require("./configDefault.js").config}a&&
(b=q.mergeObjects(a,b));c.cfg=b;c.fs.exists||(c.fs.exists=c.path.exists);c.fs.exists(c.path.resolve(c.cfg.tmpPath),function(a){a||h.mkdir(c.path.resolve(c.cfg.tmpPath),c.emptyFn)});c.cfg.engine.srcPath=c.path.resolve(c.cfg.engine.srcPath)};c.emptyFn=function(){};c.addWatcherCallback=function(a){c.callbacks.push(a)};c.mkzipN=function(a,b,d){c.debug("executing zip",a,b);var f=c.domain.create();f.on("error",function(f){c.debug("ZIP:Error",f);c.mkzip=c.mkzipJs;c.mkzipJs(a,b,d)});f.run(function(){var f;
f={cwd:c.path.resolve(b),env:process.env};c.debug("ZIP CMD::",c.progs.zip+" -rvq "+i.string(c.path.resolve(a))+" ./");f=c.child.spawn(c.progs.zip,["-rvq",c.path.resolve(a),"./"],f);f.on("exit",function(f){0!=f?(c.debug("Server::Core","Falling back to zip JS"),c.mkzip=c.mkzipJs,c.mkzipJs(a,b,d)):d("ZIP DONE")});f.stdout.on("data",function(a){c.debug("ZIP:",a.toString())})})};c.unzipN=function(a,b,d){c.debug("ZIP called",a,b);var f=c.domain.create();f.on("error",function(f){c.debug("spawn failed",f);
c.debug("Server::Core","Falling back to unzip JS");c.unzip=c.unzipJs;c.unzipJs(a,b,d)});f.run(function(){var f=c.child.spawn("unzip",["-d",b,a],null);f.on("exit",function(){d()});f.stdout.on("data",function(a){c.debug("UNZIP:",a.toString())})})};c.exec=function(a,b,d,f){var e=c.domain.create(),g="";e.on("error",function(a){c.debug("spawn failed",a);d&&d(g)});e.run(function(){var e=c.child.spawn(a,b,f);e.stdout.on("data",function(a){c.debug("Server.exec - > Process:",a.toString());g+=a.toString()});
e.on("exit",function(a){d&&d(g,a)});e.stderr.on("data",function(a){c.debug("stderr: "+a)})})};c.mkzipJs=function(a,b,d){var f=new (c.require("node-native-zip"));h.scanDir(b,function(e){h.collectSources(e,function(e){for(var k=Object.keys(e),j=0;j<k.length;){var h=k[j];++j;try{f.add(h.substring(b.length+1),e[h])}catch(i){c.debug("zip add failed",i)}}c.fs.writeFile(a,f.toBuffer(),function(){d("ZIP DONE")})})})};c.unzipJs=function(a,b,d){c.debug("unzip to:",b);c.debug("unZIP called",a,b);var f=c.require("zip");
c.fs.readFile(a,function(a,g){var k=f.Reader(g);k.toObject();var j=new I(0,function(){null!=d&&d()});k.forEach(function(a){var d=a.getName(),f=d.split("/");f.pop();f=b+"/"+f.join("/");j.add();h.mkdir(f,function(){var f=a.getData();c.fs.writeFile(b+"/"+i.string(d),f,v(j,j.done))})});var B;B=k instanceof Array?function(){return u.iter(k)}:"function"==typeof k.iterator?v(k,k.iterator):k.iterator;B()})};c.handleError=function(a,b,d){d.setHeader("Content-Type","text/plain");d.writeHead(404);d.write("Error");
d.write(a+"\r\n<br />");d.write(r.Json.stringify(b));d.write("\r\n");d.end("Not found\n")};c.getMime=function(a){return c.cfg.mimes[a]};c.getExt=function(a){return a.substring(a.lastIndexOf(".")+1)};c.getUrlParams=function(a){for(var a=a.substring(a.lastIndexOf("?")+1).split("&"),b={},d=0;d<a.length;){var c=a[d];++d;var e=c.indexOf("=");b[c.substring(0,e)]=c.substring(e+1)}return b};c.debug=function(){};c.error=function(){};c.checkAndSave=function(a,b,d){null==d&&(d=1);a=c.path.normalize(a);c.fs.exists(a,
function(f){if(f){var f=c.path.normalize(a).split(c.path.sep),e=f.pop(),g=e.split("."),k="";1<g.length&&(k="."+g.pop(),e=g.join("."));var g=d+"",j=e.substring(e.length-g.length,e.length),j=parseInt(j);c.debug("New i = ",j+1);isNaN(j)||(d=j+1);1<d&&(g=d+"",e=e.substring(0,e.length-g.length));c.debug("Checking fileName",e,g);f=i.string(f.join(c.path.sep)+c.path.sep)+e+d+k;c.checkAndSave(f,b,++d)}else b(a)})};c.mkTempName=function(a){a=a.split(".");a.splice(a.length-1,0,q.getTime());return a.join(".")};
c.prototype={onDirectoryRequest:function(){},onFileNotFound:function(){},onHttpRequest:function(){return!1},onSocketReady:function(){},watchFiles:function(a){for(var b=0;b<a.length;){var d=a[b];++b;new L(d,function(a,b,d){for(var k=0,j=c.callbacks;k<j.length;){var h=j[k];++k;h(a,b,d)}})}},initSocket:function(a,b){c.io=c.sio.listen(a);c.io.set("log level",c.cfg.logLevel);c.io.set("transports",["websocket","jsonp-polling","htmlfile","xhr-polling"]);c.io.set("close timeout",9E3);c.io.sockets.on("connection",
b)},streamFile:function(a,b,d){var f=c.fs.createReadStream(a);try{f.on("open",function(){d.setHeader("Content-Type",c.getMime(b));d.setHeader("Connection","keep-alive");d.writeHead(200);f.pipe(d)}),f.on("error",function(){d.writeHead(404);d.end("ERROR")})}catch(e){c.debug("Server::Error get filename",a)}},stat:function(a,b,d,f,e,g){var k=this;c.fs.stat(a,function(d,h){null!=d?e(h):h.isDirectory()?g(h):1E5>h.size?c.fs.readFile(a,function(d,e){null!=d?c.handleError(a,d,f):(f.setHeader("Content-Type",
c.cfg.mimes[b]),f.setHeader("Connection","keep-alive"),f.writeHead(200),f.end(e))}):k.streamFile(a,b,f)})},getFile:function(a,b,d,f,e){null==e&&(e=0);var g=this;c.cfg.webRoot.length==e?(c.debug("File not found",c.path.resolve(a,c.cfg.webRoot[e-1]+a)),this.onFileNotFound(b,d,a,c.cfg.webRoot[e-1])):this.stat(c.cfg.webRoot[e]+a,f,b,d,function(){c.cfg.webRoot.length>e-1&&g.getFile(a,b,d,f,++e)},function(){g.onDirectoryRequest(b,d,a)})},response:function(a,b){var d=a.url.indexOf("?"),c=a.url,e="";-1<d&&
(c=a.url.substring(0,d));this.onHttpRequest(a,b,c)||("/"==c?(c="/index.html",e="html"):e=c.substring(c.lastIndexOf(".")+1),b.setHeader("Access-Control-Allow-Origin","*"),this.getFile(c,a,b,e))},__class__:c};var D=function(){var a=this;c.call(this);this.watchFiles(c.cfg.watchingPaths);h.rm(c.cfg.tmpPath,function(){a.openBrowser()},!0)};D.__name__=!0;D.main=function(){c.main();c.ImportSrc=c.fs.readFileSync("Import.js","utf-8");p.exTools=c.require("../client/js/tools/tools.js").Tools;p.exOtito=c.require("../client/js/tools/otito.js").Otito;
global.Tools=p.exTools;new D;c.fs.writeFile(".pidfile",process.pid);C.addAction("itemFile",{start:function(a){c.debug("UPLOADER -> itemImage",a);return i.string(c.cfg.projectsPath)+"/"+a.project+"/"+i.string(c.cfg.project.paths.editor)+"/upload/"},finish:function(a,b){var d={success:!0,file:a.substring(a.lastIndexOf(c.path.sep)+1)};if(n.isSoundFile(a)){var f=4,e=function(){f--;0==f&&(b.write(r.Json.stringify(d)),b.end())};n.convertToMp3(a,null,e);n.convertToM4a(a,null,e);n.convertToOgg(a,null,e);
n.convertToWav(a,null,e)}else b.write(r.Json.stringify(d)),b.end()}});C.addAction("itemSound",{start:function(a){c.debug("UPLOADER -> itemSound",a);return i.string(c.cfg.projectsPath)+"/"+a.project+"/"+i.string(c.cfg.project.paths.editor)+"/upload/"},finish:function(a,b){var d={success:!0,file:a.substring(a.lastIndexOf(c.path.sep)+1)};b.write(r.Json.stringify(d));b.end()}});C.addAction("importProject",{start:function(){return i.string(c.cfg.tmpPath)+"/"},finish:function(a,b){p.importProject(a,function(a){b.write(r.Json.stringify(a));
b.end()})}});process.on("exit",function(){console.log("About to exit.");D.exit()});process.on("SIGINT",function(){D.exit();process.exit(0)})};D.exit=function(){p.stopAll()};D.__super__=c;D.prototype=T(c.prototype,{openBrowser:function(){if(c.cfg.openBrowser){var a=c.os.platform(),b="http://"+(c.cfg.host?c.cfg.host:"localhost")+":"+i.string(c.cfg.port);c.debug("opening browser",a,b);switch(a){case "linux":c.child.exec("xdg-open "+b);break;case "win":case "win32":case "win64":c.child.exec("cmd /c start "+
b);c.progs.zip="zip.bat";break;default:c.child.exec("open "+b)}}},onSocketReady:function(a){new N(a)},onDirectoryRequest:function(a,b,d){this.getFile(d+"index.html",a,b,"html")},onFileNotFound:function(a,b,d){new M(a,b,d)},onHttpRequest:function(a,b,d){return"/upload"==d?(new C(a,b),!0):-1<d.indexOf("level.php")?(new M(a,b,d),!0):!1},__class__:D});var R=function(a,b,d){this.isFailed=this.errorInConfig=!1;this.project=d;this.path=a;this.isLoading=!1;this.stack=new O("Import");this.read(b)};R.__name__=
!0;R.prototype={eval:function(a){this.isFailed=!1;for(var b=c.require("vm"),d=null,d={Import:{},ImportDef:{},ImportUnResolvedEnums:{},ClientImportDef:{},console:console},f=b.createContext(d),e=Object.keys(a),g,k,j,h=[],i=0;i<e.length;){var t=e[i];++i;try{b.runInContext(a[t],f,t)}catch(s){j=s.stack,j.replace("\r\n","\n"),k=j.split("\n"),g=k[1].substring(k[1].indexOf(c.cfg.projectsPath)+c.cfg.projectsPath.length+1),-1==j.indexOf(t)&&(g=t.substring(t.indexOf(c.cfg.projectsPath)+c.cfg.projectsPath.length+
1)),h.push({error:k[0],file:g})}}try{b.runInContext("this.FixImport();",f,"")}catch(x){j=x.stack,j.replace("\r\n","\n"),k=j.split("\n"),g=k[1].substring(k[1].indexOf(c.cfg.projectsPath)+c.cfg.projectsPath.length+1),h.push({error:k[0],file:g})}0<h.length?(this.project.emitAll("importError",h),this.errorInConfig=!0):this.errorInConfig=!1;this.ImportUnResolvedEnums=d.ImportUnResolvedEnums;this.ImportDef=d.ImportDef;this.Import=d.Import;this.ClientImportDef=d.ClientImportDef;this.isLoading=!1;this.stack.run().release()},
collectFiles:function(a,b,d,f){var e=this;0==d&&c.debug("Import:: Folders to read:",a,d);d>=a.length?(c.debug("Import collected files,",b),f(b)):h.scanDir(a[d],function(){e.collectFiles(a,b,++d,f)},h.filterEditorJs,b)},update:function(a){var b=this;if(this.isLoading)this.stack.add(a);else{this.isLoading=!0;var d=[];d.push("./Import.js");var f=[];f.push(this.path+i.string(c.path.sep)+i.string(c.cfg.project.paths.engine));var e;e=c.cfg.pluginsPaths;for(var g=0;g<e.length;){var k=e[g];++g;f.push(c.path.resolve(k.path))}e=
c.cfg.addonsPaths;for(g=0;g<e.length;)k=e[g],++g,f.push(c.path.resolve(k.path));f.push(c.path.resolve(this.path+i.string(c.path.sep)+"src"));this.collectFiles(f,d,0,function(d){h.collectSources(d,function(d){b.eval(d);null!=a&&a()})})}},get:function(a){var b=this;this.isLoading?(c.debug("Import is loading..."),this.stack.add(function(){b.get(a)})):this.isFailed?c.debug("Import failed"):a(this.Import,this.ClientImportDef,this.ImportUnResolvedEnums,this.ImportDef)},read:function(a){c.debug("Import readDB");
this.isLoading?c.debug("Import readDB - loading"):(this.Import={},this.ImportDef={},this.update(a))},__class__:R};var h=function(){};h.__name__=!0;h.mkdir=function(a,b){h.queue.push(function(){h._mkdir(a,function(){b();0<h.queue.length?h.queue.shift()():h.inProgress=!1})});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._mkdir=function(a,b){c.fs.mkdir(a,function(d){if(d)if(d.errno==c["const"][d.code])b(!0);else{var f=c.path.dirname(a);f==a?(c.debug("FS::mkdir -> Error","too many recurse callbacks",
a),c.debug("error: ",d,b.toString()),b(!0)):h._mkdir(f,function(d){d?b(d):h._mkdir(a,b)})}else b()})};h.copy=function(a,b,d,c){h.queue.push(function(){h._copy(a,b,function(){d&&d();0<h.queue.length?h.queue.shift()():h.inProgress=!1},c)});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._copy=function(a,b,d,f){c.fs.stat(a,function(e,g){e?(c.debug("FS::copy",a,b),c.debug("Failed: ",e),d&&d()):f&&!f(a,b,g)?(c.debug("filtered out (skipped)",b),d&&d()):g.isDirectory()?h._mkdir(b,function(){c.fs.readdir(a,
function(e,g){if(e)c.debug("FS::copy -> error",e);else{var B=0,m=function(){g.length>B?(h._copy(a+i.string(c.path.sep)+g[B],b+i.string(c.path.sep)+g[B],m,f),B++):d&&d()};m()}})}):h._mkdir(c.path.dirname(b),function(){h._cp(a,b,d)})})};h.cp=function(a,b,d){h.queue.push(function(){h._cp(a,b,function(){d&&d();0<h.queue.length?h.queue.shift()():h.inProgress=!1})});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._cp=function(a,b,d){var f=!1,e=c.fs.createReadStream(a);e.on("error",function(f){c.debug("FS::cp -> src error",
f,a);c.debug("FS::cp",a,b);h._mkdir(c.path.dirname(a),function(c){c?d():h._cp(a,b,d)})});var g=c.fs.createWriteStream(b);g.on("error",function(e){c.debug("FS::cp -> dst error",e);c.debug("FS::cp",a,b);f||(null!=d&&d(e),f=!0)});g.on("close",function(){f||(null!=d&&d(null),f=!0)});e.pipe(g)};h.rm=function(a,b,d){null==d&&(d=!1);h.queue.push(function(){h._rm(a,function(){b&&b();0<h.queue.length?h.queue.shift()():h.inProgress=!1},d)});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._rm=function(a,
b,d){c.fs.lstat(a,function(f,e){f?(c.debug("FS::rm -> error",f,a),b()):e.isDirectory()?c.fs.readdir(a,function(f,e){if(f)c.debug("FS::rm -> error",f,a),b&&b();else{var j=0,i=function(){e.length>j?(h._rm(a+c.path.sep+e[j],i,!1),j++):d?b&&b():c.fs.rmdir(a,b)};i()}}):c.fs.unlink(a,function(a){a?c.debug("FS::rm -> error:",a):b&&b()})})};h.scanDir=function(a,b,d,c){h.queue.push(function(){h._scanDir(a,function(a){b&&b(a);0<h.queue.length?h.queue.shift()():h.inProgress=!1},d,c)});h.inProgress||(h.inProgress=
!0,h.queue.shift()())};h._scanDir=function(a,b,d,f){var e;e=f?f:[];c.fs.readdir(a,function(f,k){f&&(c.error("FS::scanDir::readdir -> error",f),k=[]);var j=0,i=!1,m=!1,t=function(){if(j<k.length){var f=a+c.path.sep+k[j];c.fs.stat(f,function(a,g){a&&(c.debug("FS::scanDir::cbx -> error",a),b(e));m=i=!1;d&&!d(k[j],f,g)&&(i=m=!0);g.isDirectory()&&!i?(j++,h._scanDir(f,t,d,e)):(m||e.push(f),j++,t())})}else b(e)};t()})};h.scanDirShallow=function(a,b,d,c){h.queue.push(function(){h._scanDirShallow(a,function(a){b&&
b(a);0<h.queue.length?h.queue.shift()():h.inProgress=!1},d,c)});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._scanDirShallow=function(a,b,d,f){var e;e=f?f:[];c.fs.readdir(a,function(f,k){f&&c.debug("FS::scanDir -> error",f);var h=0,i=function(){if(h<k.length){var f=a+c.path.sep+k[h];c.fs.stat(f,function(a,g){a&&(c.debug("FS::scanDirShallow::cbx -> error",a),b(e));d?d(k[h],f,g)&&e.push(f):e.push(f);h++;i()})}else b(e)};i()})};h.collectSources=function(a,b){h.queue.push(function(){h._collectSources(a,
function(a){b&&b(a);0<h.queue.length?h.queue.shift()():h.inProgress=!1})});h.inProgress||(h.inProgress=!0,h.queue.shift()())};h._collectSources=function(a,b){var d=0,f={},e=function(){d<a.length?c.fs.stat(a[d],function(b,h){b?(c.debug("FS::collectSources -> error",b),d++,e()):h.isDirectory()?(d++,e(),f[a[d]]=""):c.fs.readFile(a[d],function(b,g){b&&c.debug("FS::collectSources -> failed to read file contents",b);f[a[d]]=g.toString();d++;e()})}):b(f)};e()};h.filterEditorJs=function(a,b,d){return!d?(c.debug("BAD STATS",
a),!1):d.isDirectory()||(new A(".*\\.editor\\.js$","")).match(a)};h.filterJsFiles=function(a,b,d){return!d?(c.debug("BAD STATS",a),!1):d.isDirectory()||(new A(".*\\.js$","")).match(a)};h.filterProjectFiles=function(a,b,d){return!d?(c.debug("BAD STATS",a),!1):d.isDirectory()||(new A(".*\\.js$","")).match(a)||(new A(".*\\.css$","")).match(a)||(new A(".*\\.html$","")).match(a)};h.filterEditorPlugins=function(a,b,d){return!d?(c.debug("BAD STATS",a),!1):d.isDirectory()||(new A(".*\\.editorPlugin\\.js$",
"")).match(a)};var u=function(){};u.__name__=!0;u.cca=function(a,b){var d=a.charCodeAt(b);return d!=d?void 0:d};u.substr=function(a,b,d){if(null!=b&&0!=b&&null!=d&&0>d)return"";null==d&&(d=a.length);0>b?(b=a.length+b,0>b&&(b=0)):0>d&&(d=a.length+d-b);return a.substr(b,d)};u.remove=function(a,b){for(var d=0,c=a.length;d<c;){if(a[d]==b)return a.splice(d,1),!0;d++}return!1};u.iter=function(a){return{cur:0,arr:a,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};
var I=function(a,b,d){null==d&&(d=!1);this.count=a;this.cb=b;this.debug=d};I.__name__=!0;I.prototype={add:function(a){null==a&&(a=1);this.debug&&c.debug("Jobs::add",a);this.count+=a},done:function(){this.count--;this.debug&&c.debug("Jobs::done",this.count);0==this.count&&this.cb()},__class__:I};var S=function(a){this.hasChanged=!1;this.pollingTime=1E3;var b=this;this.path=a;this.isReady=!1;this.fs=c.fs;this.stack=new O("DB");this.fs.exists(a,function(d){d?b.fs.readFile(a,"utf-8",function(a,d){if(a)c.debug("DB corrupted",
d),b.newDB();else try{b.data=r.Json.parse(d)}catch(g){b.newDB()}b.setReady()}):(b.newDB(),b.setReady())});this.startPolling()};S.__name__=!0;S.prototype={poll:function(){this.stack.run().release();this.hasChanged&&this.save();r.Timer.delay(v(this,this.poll),this.pollingTime)},startPolling:function(){this.poll()},save:function(){this.hasChanged=!1;this.fs.writeFile(this.path,JSON.stringify(this.data,null,"\t"),"utf-8")},setReady:function(){this.isReady=!0;this.startPolling()},newDB:function(){c.debug("DB:: Warning!",
"initializing new DB");this.data={1:{items:{},sub:[],name:"root",parent:0,id:1},__auto_inc:1,__branch_id:1}},forceSave:function(){this.hasChanged=!0},getBranchName:function(a){this.data[a]||c.debug("JSON DB -> Bad branchId:",a);return this.data[a].name},getData:function(a){var b=this;this.isReady?a(this.data):this.stack.add(function(){b.getData(a)})},delItem:function(a,b,d){var c=this;if(this.isReady){var e=this.data[b].items[a];delete this.data[b].items[a];this.hasChanged=!0;d(e,this.getItem(a,b))}else this.stack.add(function(){c.delItem(a,
b,d)})},newItem:function(a){var b=this.data[a.branch].items;a.id=this.data.__auto_inc;this.data.__auto_inc++;b[a.id]=a;this.hasChanged=!0;return b},set:function(a,b,d){var c=this;if(this.isReady){var e;b.branch||(b.branch=1);null!=a?(b.id||(b.id=a),e=this.data[b.branch].items,e[a]=b):e=this.newItem(b);d([e[b.id]]);this.hasChanged=!0}else this.stack.add(function(){c.set(a,b,d)})},getItem:function(a,b){if(!b)return[];var d=this.data[b],c=d.items[a];return c?[c]:this.getItem(a,d.parent)},getItemsFilter:function(a,
b,d,c){null==d&&(d=[]);null==c&&(c={});if(!b)return d;for(var b=this.data[b],e=b.items,g=Object.keys(a),h=Object.keys(e),j,i,m=0;m<h.length;){var t=h[m];++m;j=e[t];i=!0;if(!c[t]){for(var s=0;s<g.length;){var x=g[s];++s;if(j[x]!=a[x]){i=!1;break}}i&&(c[t]=j,d.push(j))}}this.getItemsFilter(a,b.parent,d,c);return d},get:function(a,b,d){var c=this;if(this.isReady){var e;e=null!=b.branch?b.branch:1;var g=[];null!=a?d(this.getItem(a,e)):(delete b.branch,this.getItemsFilter(b,e,g),d(g))}else this.stack.add(function(){c.get(a,
b,d)})},getAllItems:function(a,b){var d=this;if(this.isReady)if(this.data[a]){var f=this.data[a].items;this.data[a].parent?this.collectBranchBuffer(a,b,{}):b(f)}else c.debug("DB::AllItems -> failed to get branch",a,this.data),b([]);else this.stack.add(function(){d.getAllItems(a,b)})},collectBranchBuffer:function(a,b,d){for(var c=this.data[a].parent,a=this.data[a].items,e=Object.keys(a),g=0;g<e.length;){var h=e[g];++g;d[h]||(d[h]=a[h])}c?this.collectBranchBuffer(c,b,d):b(d)},collectBranches:function(a,
b){if(!this.data[a])return b;var d=this.data[a];null==d.name&&(d.name="Unnamed");for(var c={id:a,name:d.name,sub:[],parent:d.parent},d=d.sub,e=0;e<d.length;){var g=d[e];++e;c.sub.push(this.collectBranches(g))}return null!=b?(b.push(c),b):c},deleteBranch:function(a){var b=this.data[a],d=b.sub,c=this.data[b.parent].sub;u.remove(c,a);for(var e=0;e<d.length;){var g=d[e];++e;this.data[g].parent=b.parent;c.push(g)}delete this.data[a]},updateBranch:function(a){var b=this.data[a.id];b.id=a.id;b.name=a.name;
var d=this.data[b.parent],c=this.data[a.parent];null!=d&&(c=c.sub,u.remove(d.sub,a.id),c.push(a.id),b.parent=a.parent)},newBranch:function(a){this.data.__branch_id++;this.data[this.data.__branch_id]={items:{},name:a.name,sub:[],parent:a.parent,id:this.data.__branch_id};this.data[a.parent].sub.push(this.data.__branch_id);return this.data.__branch_id},setBranch:function(a,b){var d=this;this.isReady||this.stack.add(function(){d.setBranch(a,b)});var c=a.id;null==a.id?c=this.newBranch(a):this.updateBranch(a);
this.hasChanged=!0;b(c)},getBranchesTree:function(a,b){var d=this;if(this.isReady){null==a&&(a=1);var c=this.collectBranches(a,[]);b(c)}else this.stack.add(function(){d.getBranchesTree(a,b)})},__class__:S};var U=function(){};U.__name__=!0;var H=function(a,b,d,f,e){this.inProgress=!1;c.debug("NEW Plugin obj",b+" > "+f,e);this.itemType=b;this.cfg=d;this.project=a;this.path=f;this.origin=e;this.nameBuffer={};this.newPlugins=[]};H.__name__=!0;H.prototype={"delete":function(a,b){c.debug("Deleting plugin: reason:",
b);var d=this.nameBuffer[a];null==d?c.debug("Plugins::Delete -> Item not found",a):(d.editor.color="#ff0000",d.editor.type=this.itemType,d.disabled=1,this.project.setItem({data:d,id:d.id,branch:d.editor.branch,type:this.itemType},function(a){c.debug("Plugins::Delete -> Item updated",a)},!1))},updateFS:function(a){var b=this,d=this;c.fs.readdir(c.path.resolve(this.path),function(f,e){if(f)c.debug("Plugins::updateFS Failed to read dir",b.path,f);else{for(var g=0,h=0;h<e.length;){var j=e[h];++h;H.nameReg.match(j)&&
!d.nameBuffer[j]&&(g++,b.genNew(j,b.origin,function(){g--;0==g&&b.updateFS(a)}))}if(!(0<g)){for(var i=Object.keys(d.nameBuffer),m=!1,h=0;h<i.length;){var t=i[h];++h;m=!1;if(!0!=m){for(var s=0;s<e.length;)j=e[s],++s,t==j?m=!0:d.nameBuffer[t].editor.origin!=b.origin&&(m=!0);!0!=m&&(c.debug("Cannot find:",t),b["delete"](t,"cannot find plugin ^^^ "))}}null!=a&&a()}}})},update:function(a){var b=this;this.inProgress||(c.debug("updating plugin: "+this.itemType+" "+this.origin),this.inProgress=!0,this.nameBuffer=
{},this.project.getItems({where:{type:this.itemType,branch:1}},function(d){for(var c=0;c<d.length;){var e=d[c];++c;e.editor&&e.editor.origin==b.origin&&(b.nameBuffer[e.name]=e)}b.updateFS(function(){null!=a&&a();b.inProgress=!1})}))},genNew:function(a,b,d){null==b&&(b="Core");var c=this;this.project.getImport(function(e,g,h,j){g={id:null,name:a};e="Addon"==c.itemType?p.exTools.createAddonMeta(g,e,j):p.exTools.createPluginMeta(g,e,j);e=p.genOtito(g,e).object;j={data:null,id:null,type:c.itemType,branch:1};
j.data=e;j.data.name=a;j.data.editor={group:b,type:c.itemType,origin:b};c.project.setItem(j,function(a){c.nameBuffer[a[0].name]=a[0];d&&d()},!1)})},__class__:H};var p=function(a,b){null==b&&(b=!1);this.respawnServer=!0;this.needRedeploy=this.deployInProgress=!1;this.startServerRetries=0;this.broken=!1;this.port=0;this.removing=!1;var d=this;c.debug("Opening project:",a);p.loaded.push(this);0==p.nextPort&&(p.nextPort=c.cfg.port);this.deployCbs=[];this.name=a;this.path=c.path.normalize(i.string(c.cfg.projectsPath+
c.path.sep)+this.name).split("\\").join("/");this.privatePath=this.path+i.string(c.path.sep)+i.string(c.cfg.project.paths.editor);this.enginePath=this.path+i.string(c.path.sep)+i.string(c.cfg.project.paths.engine);this.pluginsPaths=[];for(var f=0,e=c.cfg.pluginsPaths.length;f<e;){var g=f++;this.pluginsPaths.push({path:c.path.resolve(c.cfg.pluginsPaths[g].path),origin:c.cfg.pluginsPaths[g].origin})}f=0;for(e=c.cfg.project.paths.plugins.length;f<e;)g=f++,this.pluginsPaths.push({path:c.path.resolve(this.path+
i.string(c.path.sep)+c.cfg.project.paths.plugins[g].path),origin:c.cfg.project.paths.plugins[g].origin});this.enginePluginsPath=this.enginePath+i.string(c.path.sep)+i.string(c.cfg.engine.pluginsPath);this.addonsPaths=[];f=0;for(e=c.cfg.addonsPaths.length;f<e;)g=f++,this.addonsPaths.push({path:c.path.resolve(c.cfg.addonsPaths[g].path),origin:c.cfg.addonsPaths[g].origin});f=0;for(e=c.cfg.project.paths.addons.length;f<e;)g=f++,this.addonsPaths.push({path:c.path.resolve(this.path+i.string(c.path.sep)+
c.cfg.project.paths.addons[g].path),origin:c.cfg.project.paths.addons[g].origin});this.Import=new R(this.path,v(this,this.checkItems),this);this.db=new S(this.privatePath+"/DB.json");this.enginePlugins=new H(this,c.cfg.pluginType,"Cfg",this.enginePluginsPath,"Core");c.debug("Project:plugins",this.pluginsPaths);c.debug("Project:addons",this.addonsPaths);var h="";this.plugins=[];f=0;for(e=this.pluginsPaths.length;f<e;)g=f++,h=this.pluginsPaths[g].origin,"project"==h&&(h=this.name),this.plugins.push(new H(this,
c.cfg.pluginType,"Cfg",this.pluginsPaths[g].path,h));this.addons=[];f=0;for(e=this.addonsPaths.length;f<e;)g=f++,c.debug("Plugin no:",g),h=this.addonsPaths[g].origin,"project"==h&&(h=this.name),this.addons.push(new H(this,c.cfg.addonType,"Addon",this.addonsPaths[g].path,h));this.update(function(){d.watchFiles();!b&&!c.cfg.demoMode&&d.startServer();d.broken=b;d.onStopServer=c.emptyFn;d.deploy({branch:1},null)})};p.__name__=!0;p.genOtito=function(a,b){return new p.exOtito(a,b)};p.importProject=function(a,
b){var d=a.split(c.path.sep).pop().split(".").shift();c.checkAndSave(i.string(c.cfg.projectPath)+"/"+d,function(d){var e=d.split(c.path.sep).pop();c.unzip(a,d,function(){b({success:!0,file:e})})})};p.newProject=function(a,b){var d=p.getProject(a);null!=d?b(d):c.fs.exists(i.string(c.cfg.projectsPath)+"/"+a,function(d){d?b(new p(a)):(c.debug("Trying to load non existent project!!!"),b(new p(a,!0)))})};p.getProject=function(a){for(var b=0,d=p.loaded;b<d.length;){var c=d[b];++b;if(c.name==a)return c}return null};
p.rmProject=function(a,b){var d=p.getProject(a);null!=d&&d.stop(b)};p.stopAll=function(){c.debug("Project::stopAll - stopping childs");for(var a=0,b=p.loaded;a<b.length;){var d=b[a];++a;d.stop(function(){c.debug("Project node stopped")})}};p.prototype={getPort:function(){return this.port},getAddonsType:function(){return this.addons[0].itemType},getPluginsType:function(){return this.plugins[0].itemType},getName:function(){return this.name},getPrivatePath:function(){return this.privatePath},getPath:function(){return this.path},
getBranchName:function(a){return this.db.getBranchName(a)},stopServer:function(a){this.respawnServer=!1;this.onStopServer=a?a:c.emptyFn;if(null!=this.gameServer)this.gameServer.kill();else this.onStopServer()},startServerReal:function(a){var b=this,a={cwd:a};try{this.gameServer=c.child.spawn("node",["server.js",""+p.nextPort],a),this.gameServer.on("exit",function(a){b.onStopServer();c.debug("Project::Gameserver -> process exited with code "+a);b.respawnServer&&(c.debug("respawning server"),r.Timer.delay(function(){b.startServer()},
1E3))}),this.gameServer.stdout.on("data",function(a){"setNextPort"==a.toString().trim()&&c.debug("is it calling now?")}),this.gameServer.stderr.on("data",function(a){c.debug("Project::Gameserver ERROR ->\r\n--------------------",a.toString().replace("\n","\n\t")+"\r\n--------------------------------------")})}catch(d){this.respawnServer=!1,c.debug("Project::startServer -> Error spawning child",d),this.emitAll("Error","Failed to spawn child!")}r.Timer.delay(function(){b.emitAll("updateGamePort",b.port)},
1E3)},startServer:function(){var a=this;c.debug("Project::StartServer:",this.startServerRetries);p.nextPort++;this.startServerRetries++;if(10<this.startServerRetries)this.emitAll("error","error_spawn_game_server::not_starting");else{this.port=p.nextPort;var b=c.path.resolve(this.path+"/server");c.debug("Project::StartServer -> starting","server.js:"+p.nextPort);c.fs.exists(b+"/server.js",function(d){d?a.startServerReal(b):(c.debug("Project::Gameserver -> server.js not found"),a.emitAll("error","error_spawn_game_server::not_found"))})}},
stop:function(a){u.remove(p.loaded,this);this.removing=!0;this.watcher&&this.watcher.stop();this.stopServer(a)},updateProjectAddons:function(a,b){var d=this;if(b==this.addons.length)a();else{c.debug("updateAddons "+b+"/"+(this.addons.length-1));var f=b+1;this.addons[b].update(function(){d.updateProjectAddons(a,f)})}},updateProjectPlugins:function(a,b){var d=this;if(b==this.plugins.length)a();else{var c=b+1;this.plugins[b].update(function(){d.updateProjectPlugins(a,c)})}},updatePlugins:function(a){var b=
this;this.enginePlugins.update(function(){b.updateProjectPlugins(function(){b.updateProjectAddons(a,0)},0)})},update:function(a){var b=this;this.Import.update(function(){b.Import.errorInConfig?c.debug("error in config.. skipping rest checks..."):b.updatePlugins(function(){b.checkItems(function(){b.deploy({branch:1},function(){a&&a()})})})})},onSourceChanged:function(a,b,d){c.debug("Watcher event...",d);this.removing||(this.emitAll("sourceChanged",a),this.update())},watchFiles:function(){var a=this;
c.fs.stat(this.path,function(b){if(null!=b)c.debug("Project::watchFiles::Stat -> FATAL ERROR",b);else try{c.debug("Watching files"),a.watcher=c.cfg.engineDevMode?new L(a.path,v(a,a.onSourceChanged)):new L(a.path+"/src",v(a,a.onSourceChanged))}catch(d){c.debug("Project::watcher -> failed",d)}});c.addWatcherCallback(v(this,this.onSourceChanged))},emitAll:function(a,b){F.emitAllStatic(a,b,this.name)},"export":function(a){var b=c.path.resolve(i.string(c.cfg.projectsPath)+"/"+this.name),d=b+"/.editor/"+
this.name+"."+i.string(c.cfg.projectExtension);c.fs.exists(d,function(f){f?c.fs.unlink(d,function(){c.mkzip(d,b,a)}):(c.debug("Project::ZIP",d,b),c.mkzip(d,b,a))})},deploy:function(a,b,d){var f=this;null!=b&&this.deployCbs.push(b);this.deployInProgress?(c.debug("Project -> Deploy in progress..."),this.needRedeploy=!0,null!=b&&b()):(this.deployInProgress=!0,new Q(this,a,function(b){f.deployInProgress=!1;if(f.needRedeploy)f.needRedeploy=!1,f.deploy(a,null,d);else for(;0<f.deployCbs.length;)f.deployCbs.shift()(b)},
d))},checkAllItems:function(a){var b=this,d=[];this.Import.get(function(f,e,g,h){b.Import.errorInConfig||(b.emitAll("updateImport",{Import:f,ImportDef:e}),p.exOtito.setImport(f),p.exOtito.setImportDef(h),b.db.getData(function(e){var g=Object.keys(e);u.remove(g,"__auto_inc");u.remove(g,"__branch_id");for(var i={},t=0;t<g.length;){var s=g[t];++t;for(var s=e[s].items,x=Object.keys(s),l=0;l<x.length;){var J=x[l];++l;var n=s[J].data;if(!n){c.debug("BROKEN DB!!!!!!!!!!!!!!!!!!!!!!!!",J);return}!n.editor||
!n.editor.type?c.debug("Project -> check -> List: skipping item",n):(i[n.editor.type]||(i[n.editor.type]=q.inArray(c.cfg.emptyList,n.editor.type)?{}:{"0":""}),i[n.editor.type][J]=n.name)}p.exOtito.setLists(i);for(l=0;l<x.length;){J=x[l];++l;var n=s[J].data,r=null;if(n.editor){if("Plugin"==n.editor.type)r=p.exTools.createPluginMeta(n,f,h);else if("Addon"==n.editor.type)r=p.exTools.createAddonMeta(n,f,h);else{if(!n.editor.plugin)continue;r=p.exTools.createMeta(n,null,null,f,h)}null!=r&&c.cfg.autoFixConfigChanges&&
(n=p.genOtito(n,r),n._isChanged&&n.object.id&&(s[J].data=n.object,c.debug("Setting item",n.object),d.push(s[J].data)))}}}0<d.length&&b.db.forceSave();b.emitAll("itemsChanged",d);null!=a&&a(d)}))})},checkItems:function(a){this.checkAllItems(a)},resolveEnums:function(a,b){var d=Object.keys(a),f;f=q.isArray(a)?[]:{};for(var e=0;e<d.length;){var g=d[e];++e;var h=a[g],j=typeof h;"object"==j&&h?f[g]=this.resolveEnums(h,b):"string"!=j?f[g]=h:0!=h.indexOf(q.enumStr)?f[g]=h:(j=q.resolveEnums(h,b),null==j?
c.debug("Project::resolve enums -> Cannot resolve enum!!!",h):f[g]=j)}return f},fixAllItems:function(a){for(var b=[],d=Object.keys(a),c,e=0;e<d.length;)c=d[e],++e,c=a[c],b.push(this.fixItem(c));return b},fixItems:function(a){for(var b=[],d=0;d<a.length;){var c=a[d];++d;b.push(this.fixItem(c))}return b},fixItem:function(a){if(!a)return c.debug("fixing item NULL"),null;a.data||(c.debug("fixing item data NULL"),a.data={});a.data.editor||(c.debug("fixing item.data.editor NULL",a),a.data.editor={});a.data.id=
a.id;a.data.editor.branch=a.branch;a.data.editor.type=a.type;return a.data},deleteBranch:function(a,b){this.db.deleteBranch(a);b()},setBranch:function(a,b){var d=this;this.db.setBranch(a,function(a){d.deploy({branch:a},function(){d.getBranchesTree(1,b)})})},getBranchesTree:function(a,b){this.db.getBranchesTree(a,b)},delItemReal:function(a,b){var d=this;this.db.delItem(a.id,a.branch,function(c,e){d.checkItems();var g=d.fixItem(c),h=d.fixItems(e);b(g,h);(null==e||0==e.length)&&d.emitAll("itemDeleted",
g);d.emitAll("itemsChanged",h);d.updatePlugins(function(){d.deploy({branch:a.branch},null)})})},delItem:function(a,b){this.delItemReal(a,b)},setItem:function(a,b,d){null==d&&(d=!0);var c=this;this.db.set(a.id,a,function(e){var g=c.fixItems(e);d?c.deploy({branch:a.branch},function(){b(g);c.emitAll("itemsChanged",g)}):(c.emitAll("itemsChanged",g),b(g))})},getAllItems:function(a,b){var d=this;this.db.getAllItems(a,function(a){b(d.fixAllItems(a))})},getItems:function(a,b){var d=this;this.db.get(a.id,
a.where,function(a){b(d.fixItems(a))})},getImport:function(a){this.Import.get(a)},isBroken:function(){return this.broken},__class__:p};var w=function(){};w.__name__=!0;w.hasField=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};w.field=function(a,b){var d=null;try{d=a[b]}catch(c){}return d};w.fields=function(a){var b=[];if(null!=a){var d=Object.prototype.hasOwnProperty,c;for(c in a)"__id__"!=c&&("hx__closures__"!=c&&d.call(a,c))&&b.push(c)}return b};w.isFunction=function(a){return"function"==
typeof a&&!(a.__name__||a.__ename__)};w.deleteField=function(a,b){if(!w.hasField(a,b))return!1;delete a[b];return!0};var O=function(a,b){null==b&&(b=!1);this.name=a;this.buffer=[];this.tmpBuffer=[];this.isRunning=!1;this.debug=b};O.__name__=!0;O.prototype={release:function(){this.buffer.length=0;this.debug&&c.debug("Stack::Release",this.name);return this},runTmp:function(){this.debug&&c.debug("Stack::RunTMP",this.name,this.tmpBuffer.length);if(0==this.tmpBuffer.length)this.isRunning=!1;else{for(var a=
0,b=this.tmpBuffer;a<b.length;){var d=b[a];++a;this.buffer.push(d)}this.tmpBuffer.length=0;this.isRunning=!1;this.run()}},run:function(){if(this.isRunning)return this;this.debug&&c.debug("Stack::Run",this.name,this.buffer.length);this.isRunning=!0;for(var a=0,b=this.buffer;a<b.length;){var d=b[a];++a;d()}this.runTmp();return this},add:function(a){this.debug&&c.debug("Stack::Add",this.name,this.buffer.length);if(this.isRunning)return this.tmpBuffer.push(a),this;this.buffer.push(a);return this},__class__:O};
var i=function(){};i.__name__=!0;i.string=function(a){return z.Boot.__string_rec(a,"")};i.parseInt=function(a){var b=parseInt(a,10);if(0==b&&(120==u.cca(a,1)||88==u.cca(a,1)))b=parseInt(a);return isNaN(b)?null:b};i.parseFloat=function(a){return parseFloat(a)};var P=function(){this.b=""};P.__name__=!0;P.prototype={addSub:function(a,b,d){this.b+=null==d?u.substr(a,b,null):u.substr(a,b,d)},__class__:P};var y=function(){};y.__name__=!0;y.urlDecode=function(a){return decodeURIComponent(a.split("+").join(" "))};
y.htmlEscape=function(a,b){a=a.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;");return b?a.split('"').join("&quot;").split("'").join("&#039;"):a};y.isSpace=function(a,b){var d=u.cca(a,b);return 8<d&&14>d||32==d};y.ltrim=function(a){for(var b=a.length,d=0;d<b&&y.isSpace(a,d);)d++;return 0<d?u.substr(a,d,b-d):a};y.rtrim=function(a){for(var b=a.length,d=0;d<b&&y.isSpace(a,b-d-1);)d++;return 0<d?u.substr(a,0,b-d):a};y.trim=function(a){return y.ltrim(y.rtrim(a))};y.replace=function(a,
b,d){return a.split(b).join(d)};var q=function(){};q.__name__=!0;q.clone=function(a){var b;if(!a||"object"!=typeof a)return a;if(q.isArray(a)){b=[];for(var d=0;d<a.length;){var c=a[d];++d;"object"===typeof c&&null!=c?b.push(q.clone(c)):b.push(c)}return b}b={};c=Object.keys(a);for(d=0;d<c.length;){var e=c[d];++d;var g=a[e];b[e]="object"===typeof g&&null!=g?q.clone(g):g}return b};q.mergeObjects=function(a,b){if(null==a)return q.clone(b);if(null==b)return q.clone(a);var d=q.clone(a);if("object"!=typeof b)return d;
for(var c=Object.keys(b),e=0;e<c.length;){var g=c[e];++e;var h=K["typeof"](a[g]),j=K["typeof"](b[g]);null!=h?"undefined"!=j&&(d[g]=q.mergeObjects(d[g],q.clone(b[g]))):"undefined"==h&&(d[g]=b[g])}return d};q.getType=function(a){return typeof a};q.resolveEnums=function(a,b){var d=a.substring(q.enumStr.length);return q.resolveObject(d,b)};q.resolveObject=function(a,b){var d=a.split(".");d.shift();for(var f=b,e=0;e<d.length;){var g=d[e];++e;f=f[g];if(null==f){c.debug("Tools::resolveObject Cannot resolve",
a);break}}return f};q.inArray=function(a,b){for(var d=0;d<a.length;){var c=a[d];++d;if(c==b)return!0}return!1};q.splitInLines=function(a){return a.split("\r\n").join("\n").split("\r").join("\n").split("\n")};q.isArray=function(a){return Array.isArray(a)};q.getTime=function(){return Date.now()};q.shellEscape=function(a){return a};var l={__ename__:!0,__constructs__:"TNull TInt TFloat TBool TObject TFunction TClass TEnum TUnknown".split(" "),TNull:["TNull",0]};l.TNull.toString=E;l.TNull.__enum__=l;l.TInt=
["TInt",1];l.TInt.toString=E;l.TInt.__enum__=l;l.TFloat=["TFloat",2];l.TFloat.toString=E;l.TFloat.__enum__=l;l.TBool=["TBool",3];l.TBool.toString=E;l.TBool.__enum__=l;l.TObject=["TObject",4];l.TObject.toString=E;l.TObject.__enum__=l;l.TFunction=["TFunction",5];l.TFunction.toString=E;l.TFunction.__enum__=l;l.TClass=function(a){a=["TClass",6,a];a.__enum__=l;a.toString=E;return a};l.TEnum=function(a){a=["TEnum",7,a];a.__enum__=l;a.toString=E;return a};l.TUnknown=["TUnknown",8];l.TUnknown.toString=E;
l.TUnknown.__enum__=l;var K=function(){};K.__name__=!0;K["typeof"]=function(a){switch(typeof a){case "boolean":return l.TBool;case "string":return l.TClass(String);case "number":return Math.ceil(a)==a%2147483648?l.TInt:l.TFloat;case "object":if(null==a)return l.TNull;var b=a.__enum__;if(null!=b)return l.TEnum(b);a=a.__class__;return null!=a?l.TClass(a):l.TObject;case "function":return a.__name__||a.__ename__?l.TObject:l.TFunction;case "undefined":return l.TNull;default:return l.TUnknown}};K.enumIndex=
function(a){return a[1]};var G=function(a,b,d,c){this.project=a;this.editor=c;this.callback=d;this.data=b};G.__name__=!0;G.prototype={removeFile:function(){try{c.fs.unlinkSync(this.project.getPath()+"/"+i.string(this.data.path))}catch(a){}this.callback()},deleteUITemplate:function(){this.name=this.normalizeName(this.data.name);var a=this.project.getPath()+"/"+this.getTemplatePath();if(c.fs.existsSync(a)){try{c.fs.unlinkSync(a+"/base.css")}catch(b){}try{c.fs.unlinkSync(a+"/base.js")}catch(d){}try{c.fs.unlinkSync(a+
"/index.html")}catch(f){}try{c.fs.unlinkSync(a+"/"+this.name+".html")}catch(e){}var g=a+"/"+this.name+".css";if(c.fs.existsSync(g)){var h=new String(c.fs.readFileSync(g));h==this.getCustomCSS()&&c.fs.unlinkSync(g)}g=a+"/"+this.name+".js";c.fs.existsSync(g)&&(h=new String(c.fs.readFileSync(g)),h==this.getCustomJS()&&c.fs.unlinkSync(g));try{c.fs.rmdirSync(a+"/img")}catch(j){}try{c.fs.rmdirSync(a)}catch(i){}}this.callback()},listSubtemplates:function(){var a=[],b=null,b=function(d){for(var c=0,e=d.length;c<
e;){var g=c++,g=d[g];if(null!=g.options._subtemplate){for(var h=!1,j=0;j<a.length;){var i=a[j];++j;if(i==g.options._subtemplate){h=!0;break}}h||a.push(g.options._subtemplate)}"panel"==g.type&&b(g.children)}};b(this.data.objects);return a},getCSSProperties:function(a){for(var b=[],d=0,c=w.fields(a);d<c.length;){var e=c[d];++d;var g=""+i.string(w.field(a,e));0!=g.length&&b.push(e+": "+g)}return b.join("; ")},getAttribs:function(a){for(var b=[],d=0,c=w.fields(a);d<c.length;){var e=c[d];++d;var g=""+
i.string(w.field(a,e));0!=g.length&&b.push(" "+e+'="'+y.htmlEscape(g,!0)+'"')}return b.join("")},getIndent:function(a){for(var b="",d=0;d<a;)d++,b+="  ";return b},getCustomJS:function(){return'\n"use strict";\n\nmighty.TemplateJS["'+this.name+'"] = function()\n{\n  this.onShow = function() {\n    \n  }\n};\n'},getBaseJS:function(){var a="// This is script-generated JS. Don't change! Any changes will be lost on next template save.\n\n";this.data.normal_name=this.name;var b=[],d=null,d=function(a,b){for(var c=
0;c<a.length;){var e=a[c];++c;if("panel"==e.type){var f={id:e.id,is_first:e.is_first,align:e.options.align,anchor_align:e.options.anchor_align,children:[],css:{},height:e.options.height};null!=e.left&&(f.left=e.left);null!=e.right&&(f.right=e.right);null!=e.top&&(f.top=e.top);null!=e.bottom&&(f.bottom=e.bottom);for(var g=["position","left","right","top","bottom"],h=0;h<g.length;){var i=g[h];++h;var k=w.field(e.options.css,i);null!=k&&(f.css[i]=k)}"auto"==e.options.width&&(f.auto_width=!0);"auto"==
e.options.height&&(f.auto_height=!0);g=!0;h=0;for(i=z.Boot.__cast(e.children,Array);h<i.length;)if(k=i[h],++h,"panel"!=k.type){g=!1;break}f.ch_all_panels=g;b.push(f);d(e.children,f.children)}}};d(this.data.objects,b);this.data.objects=b;for(var a=a+'"use strict";\n\nvar mighty = mighty || {};\n\n',a=a+"mighty.templatebase = mighty.templatebase || {};\n\n",a=a+"mighty.TemplateJS = mighty.TemplateJS || {};\n\n",a=a+('mighty.templatebase["'+this.name+'"] = function(){\n\n'),a=a+("  var data = "+r.Json.stringify(this.data)+
";\n\n"),a=a+i.string(c.fs.readFileSync("../client/js/plugins/ui/base_part.js")),a=a+"};\n\n\n",b=this.project.getPath(),f=0,e=this.subtemplates;f<e.length;){var g=e[f];++f;var h=b+"/src/widgets/"+g+"/"+g+".js";c.fs.existsSync(h)&&(a+="/* file: widgets/"+g+"/"+g+".js:  */\n"+i.string(c.fs.readFileSync(h)))}return a},getCustomCSS:function(){return"/* Here you can write customized CSS. Classes and IDs should be prefixed with template name, e.g.: .mytemplate-form */\n\n"},setCSS:function(a,b){for(var d=
0,c=w.fields(b);d<c.length;){var e=c[d];++d;a[e]=w.field(b,e)}},getBaseCSS:function(){var a=this,b;b="/* This is script-generated CSS. Don't change! Any changes will be lost on next template save. */\n\n"+("."+this.name+"-panel { position: absolute; overflow: auto; }\n");b+="."+this.name+"-panel > .wrap {  \n  position: absolute;\n  left: 0;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  overflow: inherit;\t\t\n\t\t }\n\t\t \n\t\t ."+this.name+"-panel > .wrap.static {\n  position: relative;\n  left: auto;\n  top: auto;\n  right: auto;\n  bottom: auto;\n\t\t }\n";
this.data.hide_custom_css&&(b+="."+this.name+"-panel > .wrap { \n  border: 1px solid black; \n\t\t\t}\n");b+="."+this.name+"-template { position: relative; width: 100%; height: 100%; }\n";b+="."+this.name+"-template * { font-family: Arial, sans-serif; font-size: 14px; color: white; }\n";b+="."+this.name+"-template button { color: inherit; font: inherit; }\n\n";b+="."+this.name+"-template button {\n\tdisplay: inline-block;\n\tmin-width: 50px;\n\tpadding: 5px 10px;\n\tmargin: 0 9px 6px 0;\n\tfont-family: arial, sans-serif;\n\tfont-size: 13px;\n\ttext-align: center;\n\tcursor: pointer;\n\t\n\tborder: 1px solid rgba(0,0,0,0.4);\n\tborder-radius: 3px;\n\tbox-shadow: 0 1px 0 rgba(255,255,255,0.1) inset;\n\t\n\tbackground: #404040; /* Old browsers */\n\t/* IE9 SVG, needs conditional override of 'filter' to 'none' */\n\tbackground: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzQwNDA0MCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzMDMwMzAiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);\n\tbackground: -moz-linear-gradient(top,  #404040 0%, #303030 100%); /* FF3.6+ */\n\tbackground: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#404040), color-stop(100%,#303030)); /* Chrome,Safari4+ */\n\tbackground: -webkit-linear-gradient(top,  #404040 0%,#303030 100%); /* Chrome10+,Safari5.1+ */\n\tbackground: -o-linear-gradient(top,  #404040 0%,#303030 100%); /* Opera 11.10+ */\n\tbackground: -ms-linear-gradient(top,  #404040 0%,#303030 100%); /* IE10+ */\n\tbackground: linear-gradient(to bottom,  #404040 0%,#303030 100%); /* W3C */\n\tfilter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#404040', endColorstr='#303030',GradientType=0 ); /* IE6-8 */\n}\n."+
this.name+"-template button:hover {\n\tbox-shadow: 0 1px 0 rgba(0,0,0,0.2) inset;\n\t\n\tbackground: #303030; /* Old browsers */\n\t/* IE9 SVG, needs conditional override of 'filter' to 'none' */\n\tbackground: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzMwMzAzMCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMyMDIwMjAiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);\n\tbackground: -moz-linear-gradient(top,  #303030 0%, #202020 100%); /* FF3.6+ */\n\tbackground: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#303030), color-stop(100%,#202020)); /* Chrome,Safari4+ */\n\tbackground: -webkit-linear-gradient(top,  #303030 0%,#202020 100%); /* Chrome10+,Safari5.1+ */\n\tbackground: -o-linear-gradient(top,  #303030 0%,#202020 100%); /* Opera 11.10+ */\n\tbackground: -ms-linear-gradient(top,  #303030 0%,#202020 100%); /* IE10+ */\n\tbackground: linear-gradient(to bottom,  #303030 0%,#202020 100%); /* W3C */\n\tfilter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#303030', endColorstr='#202020',GradientType=0 ); /* IE6-8 */\n}\n\t\t\n\t\t";
var d=null,d=function(b){for(var c="",e=0,f=b.length;e<f;){var g=e++,g=b[g],h="."+a.name+"-"+g.id;switch(g.type){case "panel":var i={};""!=g.options.width&&(i.width="auto"==g.options.width?"auto":g.options.width+g.options.width_units);""!=g.options.height&&(i.height="auto"==g.options.height?"auto":g.options.height+g.options.height_units);""!=g.options.bg_image&&(i["background-image"]='url("'+g.options.bg_image+'")',i["background-repeat"]="no-repeat");a.setCSS(i,g.options.css);c+=h+" { "+a.getCSSProperties(i)+
" }\n";i={};"auto"==g.options.width&&(i["overflow-x"]="hidden");"auto"==g.options.height&&(i["overflow-y"]="hidden");0<w.fields(i).length&&(c+=h+" > .wrap { "+a.getCSSProperties(i)+" }\n");c+=d(g.children);break;case "label":i={};""!=g.options.align&&(i["text-align"]=g.options.align);a.setCSS(i,g.options.css);c+=h+" { "+a.getCSSProperties(i)+" }\n";break;case "button":i={},a.setCSS(i,g.options.css),c+=h+" { "+a.getCSSProperties(i)+" }\n"}}return c};b+=d(this.data.objects)+"\n\n";for(var f=this.project.getPath(),
e=0,g=this.subtemplates;e<g.length;){var h=g[e];++e;var j=f+"/src/widgets/"+h+"/"+h+".css";c.fs.existsSync(j)&&(b+="/* file: widgets/"+h+"/"+h+".css:  */\n"+i.string(c.fs.readFileSync(j)))}return b},getFullHTML:function(){var a;a="<!DOCTYPE html>\n<html>\n<head>\n  <meta charset='utf-8'>\n  <\!-- This is script-generated HTML. Don't change! Any changes will be lost on next template save. --\>\n";a+="  <title>"+i.string(this.data.name)+"</title>\n";a+="  <style type='text/css'>\n";a+="    html { height: 100%; }\n";
a+="    body { height: 100%; margin: 0; padding: 0; }\n";a+="  </style>\n";a+='  <link rel="stylesheet" href="base.css" type="text/css" media="all" />\n';if(null==this.data.hide_custom_css||!this.data.hide_custom_css)a+='  <link rel="stylesheet" href="'+this.name+'.css" type="text/css" media="all" />\n';a+='  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"><\/script>\n';a+='  <script type="text/javascript" src="../../../../engine/library/class.js"><\/script>\n';a+='  <script type="text/javascript" src="/engine/plugins/Template/PanelWidget.js"><\/script>\n';
a+="</head>\n<body style='background:white'>\n";var b=this.getMainHTMLInfo();a+=b.html;a+='  <script type="text/javascript" src="base.js"><\/script>\n';a+='  <script type="text/javascript" src="'+this.name+'.js"><\/script>\n';a+="\n\t\t\t<script>\n\t\t\t\t$(function(){\n\t\t\t\t\tmighty.templatebase['"+this.name+"']();\n\t\t\t\t\t//new mighty.TemplateJS['"+this.name+"']().onShow();\n\t\t\t\t});\n\t\t\t<\/script>\n\t\t";return a+="</body>\n</html"},normalizeName:function(a){return y.replace(a," ",
"_")},getMainHTMLInfo:function(){var a=this,b="  <div class='"+this.name+"-template'>\n",d=function(b){var d={},c=w.field(b.options,"class");null==c&&(c="");c=c.split(" ");"panel"==b.type&&c.push(a.name+"-panel");c.push(a.name+"-"+i.string(b.id));null!=b.options.id&&0<b.options.id.length&&(d.id=b.options.id);d["class"]=c.join(" ");null!=b.options.data_var&&0<b.options.data_var.length&&(d["data-var"]=b.options.data_var);null!=b.options.data_click&&0<b.options.data_click.length&&(d["data-click"]=b.options.data_click);
return d},c=null,c=function(b,g){for(var h="",i=0,n=b.length;i<n;){var m=i++,m=b[m];switch(m.type){case "panel":for(var l=d(m),p="auto"==m.options.width||"auto"==m.options.height,q=0,r=m.children,u=0,v=r.length;u<v;){var w=u++;"panel"==r[w].type&&q++}q==r.length&&(p=!1);h+=a.getIndent(g)+"<div"+a.getAttribs(l)+"><div class='wrap"+(p?" static":"")+"'>\n";h+=c(m.children,g+1);null!=m.options.html&&(h+="\n"+m.options.html+"\n");h+=a.getIndent(g)+"</div></div>\n";break;case "label":l=d(m);h+=a.getIndent(g)+
"<div"+a.getAttribs(l)+">"+y.replace(y.htmlEscape(m.options.text),"\n","<br/>")+"</div>\n";break;case "button":l=d(m),h+=a.getIndent(g)+"<button"+a.getAttribs(l)+">"+y.htmlEscape(m.options.label)+"</button>\n"}}return h},b=b+c(this.data.objects,2);return{html:b+"  </div>\n"}},getTemplatePath:function(){var a="widget"==this.data.type?"src/widgets":"src/templates";return a+="/"+this.name},generateHtml:function(){var a=this,b=c.require("wrench");this.templates_path="widget"==this.data.type?"src/widgets":
"src/templates";var d=this.project.getPath();this.name=this.normalizeName(this.data.name);if(!this.data.use_tmp_folder&&null!=this.data.old_item&&(this.data.type!=this.data.old_item.type||this.name!=this.data.old_item.normal_name)){var f=this.data.old_item.normal_name,e=d+"/"+("widget"==this.data.old_item.type?"src/widgets":"src/templates")+"/"+f,g=d+"/"+this.templates_path+"/"+this.name;if(e!=g&&c.fs.existsSync(e)){c.fs.renameSync(e,g);try{var i=g+"/"+this.name+".js";c.fs.unlinkSync(g+"/"+f+".html");
c.fs.renameSync(g+"/"+f+".js",i);c.fs.renameSync(g+"/"+f+".css",g+"/"+this.name+".css");var j=(new String(c.fs.readFileSync(i))).split("\n");y.trim(j[3])=='mighty.TemplateJS["'+f+'"] = function()'&&(j[3]='mighty.TemplateJS["'+this.name+'"] = function()',c.fs.writeFileSync(i,j.join("\n")))}catch(n){}}}c.fs.existsSync(d+"/"+this.templates_path)||c.fs.mkdirSync(d+"/"+this.templates_path);this.folder=this.data.use_tmp_folder?".editor":this.name;this.tpl_path=this.templates_path+"/"+this.folder;var m=
this.tpl_path+"/index.html",l=this.getMainHTMLInfo(),p=this.tpl_path+"/"+this.folder+".html",f=l.html;this.subtemplates=this.listSubtemplates();this.data.use_tmp_folder&&b.rmdirSyncRecursive(d+"/"+this.tpl_path,!0);c.fs.existsSync(d+"/"+this.tpl_path)||c.fs.mkdirSync(d+"/"+this.tpl_path);c.fs.writeFileSync(d+"/"+p,"  <\!-- This is script-generated HTML. Don't change! Any changes will be lost on next template save. --\>\n\n"+f);b=function(){c.fs.writeFileSync(d+"/"+m,a.getFullHTML());c.fs.writeFileSync(d+
"/"+a.tpl_path+"/base.css",a.getBaseCSS());c.fs.writeFileSync(d+"/"+a.tpl_path+"/base.js",a.getBaseJS());var b=d+"/"+a.tpl_path+"/"+a.name+".css";c.fs.existsSync(b)||c.fs.writeFileSync(b,a.getCustomCSS());b=d+"/"+a.tpl_path+"/"+a.name+".js";c.fs.existsSync(b)||c.fs.writeFileSync(b,a.getCustomJS());w.deleteField(l,"html");l.html_path=p;a.callback({normal_name:a.name,html_path:m,html_info:l})};f=d+"/"+this.templates_path+"/"+this.name;this.data.use_tmp_folder&&c.fs.existsSync(f)?h.copy(f,d+"/"+this.tpl_path,
b):b()},__class__:G};var C=function(a,b){var d=c.getUrlParams(a.url);if(null==d.action)b.end(),c.debug("upload without an action",d);else{var f=C.actions[d.action];if(null==f)b.end(),c.debug("Uploader: unknown action",d);else{c.debug("Upload action",d.action);var e=f.start(d)+d.qqfile,g=c.cfg.tmpPath+c.path.sep+c.mkTempName(d.qqfile),i=c.fs.createWriteStream(c.path.resolve(g));i.on("error",function(){c.debug("Uploader::WS - could not open writestream.",c.path.resolve(g))});i.on("close",function(){c.checkAndSave(e,
function(a){c.debug("UPLOAD",a);h.copy(g,a,function(){b.writeHead(200,"OK",{"Content-Type":"text/html"});c.debug("UPLOAD DONE",a);f.finish(a,b)})})});a.on("data",function(a){i.write(a)});a.on("end",function(){i.end()})}}};C.__name__=!0;C.addAction=function(a,b){C.actions[a]=b};C.prototype={__class__:C};var r={Json:function(){}};r.Json.__name__=!0;r.Json.parse=function(a){return(new r.Json).doParse(a)};r.Json.stringify=function(a,b){return(new r.Json).toString(a,b)};r.Json.prototype={parseNumber:function(a){for(var b=
this.pos-1,d=45==a,c=!d,e=48==a,g=!1,h=!1,j=!1,l=!1;;){a=this.str.charCodeAt(this.pos++);switch(a){case 48:e&&!g&&this.invalidNumber(b);d&&(d=!1,e=!0);c=!0;break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:e&&!g&&this.invalidNumber(b);d&&(d=!1);c=!0;e=!1;break;case 46:(d||g)&&this.invalidNumber(b);c=!1;g=!0;break;case 101:case 69:(d||e||h)&&this.invalidNumber(b);c=!1;h=!0;break;case 43:case 45:(!h||j)&&this.invalidNumber(b);c=!1;j=!0;break;default:c||this.invalidNumber(b),
this.pos--,l=!0}if(l)break}a=i.parseFloat(u.substr(this.str,b,this.pos-b));b=a|0;return b==a?b:a},invalidNumber:function(a){throw"Invalid number at position "+a+": "+u.substr(this.str,a,this.pos-a);},parseString:function(){for(var a=this.pos,b=new P;;){var d=this.str.charCodeAt(this.pos++);if(34==d)break;if(92==d){b.addSub(this.str,a,this.pos-a-1);d=this.str.charCodeAt(this.pos++);switch(d){case 114:b.b+="\r";break;case 110:b.b+="\n";break;case 116:b.b+="\t";break;case 98:b.b+="\b";break;case 102:b.b+=
"\f";break;case 47:case 92:case 34:b.b+=String.fromCharCode(d);break;case 117:a=i.parseInt("0x"+u.substr(this.str,this.pos,4));this.pos+=4;b.b+=String.fromCharCode(a);break;default:throw"Invalid escape sequence \\"+String.fromCharCode(d)+" at position "+(this.pos-1);}a=this.pos}else if(d!=d)throw"Unclosed string";}b.addSub(this.str,a,this.pos-a-1);return b.b},parseRec:function(){for(;;){var a=this.str.charCodeAt(this.pos++);switch(a){case 32:case 13:case 10:case 9:break;case 123:for(var b={},d=null,
a=null;;){var c=this.str.charCodeAt(this.pos++);switch(c){case 32:case 13:case 10:case 9:break;case 125:return(null!=d||!1==a)&&this.invalidChar(),b;case 58:null==d&&this.invalidChar();b[d]=this.parseRec();d=null;a=!0;break;case 44:a?a=!1:this.invalidChar();break;case 34:a&&this.invalidChar();d=this.parseString();break;default:this.invalidChar()}}break;case 91:b=[];for(a=null;;)switch(c=this.str.charCodeAt(this.pos++),c){case 32:case 13:case 10:case 9:break;case 93:return!1==a&&this.invalidChar(),
b;case 44:a?a=!1:this.invalidChar();break;default:a&&this.invalidChar(),this.pos--,b.push(this.parseRec()),a=!0}break;case 116:a=this.pos;if(114!=this.str.charCodeAt(this.pos++)||117!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return!0;case 102:a=this.pos;if(97!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||115!=this.str.charCodeAt(this.pos++)||101!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return!1;
case 110:a=this.pos;if(117!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++)||108!=this.str.charCodeAt(this.pos++))this.pos=a,this.invalidChar();return null;case 34:return this.parseString();case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 45:return this.parseNumber(a);default:this.invalidChar()}}},invalidChar:function(){this.pos--;throw"Invalid char "+this.str.charCodeAt(this.pos)+" at position "+this.pos;},doParse:function(a){this.str=a;this.pos=
0;return this.parseRec()},quote:function(a){this.buf.b+='"';for(var b=0;;){var d=a.charCodeAt(b++);if(d!=d)break;switch(d){case 34:this.buf.b+='\\"';break;case 92:this.buf.b+="\\\\";break;case 10:this.buf.b+="\\n";break;case 13:this.buf.b+="\\r";break;case 9:this.buf.b+="\\t";break;case 8:this.buf.b+="\\b";break;case 12:this.buf.b+="\\f";break;default:this.buf.b+=String.fromCharCode(d)}}this.buf.b+='"'},toStringRec:function(a,b){null!=this.replacer&&(b=this.replacer(a,b));var d=K["typeof"](b);switch(d[1]){case 8:this.buf.b+=
'"???"';break;case 4:this.objString(b);break;case 1:this.buf.b+=i.string(b);break;case 2:this.buf.b+=i.string(Math.isFinite(b)?b:"null");break;case 5:this.buf.b+='"<fun>"';break;case 6:d=d[2];if(d==String)this.quote(b);else if(d==Array){d=b;this.buf.b+="[";var c=d.length;if(0<c){this.toStringRec(0,d[0]);for(var e=1;e<c;)this.buf.b+=",",this.toStringRec(e,d[e++])}this.buf.b+="]"}else if(d==r.ds.StringMap){d=b;c={};for(e=d.keys();e.hasNext();){var g=e.next();c[g]=d.get(g)}this.objString(c)}else this.objString(b);
break;case 7:e=K.enumIndex(b);this.buf.b+=i.string(e);break;case 3:this.buf.b+=i.string(b);break;case 0:this.buf.b+="null"}},objString:function(a){this.fieldsString(a,w.fields(a))},fieldsString:function(a,b){var c=!0;this.buf.b+="{";for(var f=0;f<b.length;){var e=b[f];++f;var g=w.field(a,e);w.isFunction(g)||(c?c=!1:this.buf.b+=",",this.quote(e),this.buf.b+=":",this.toStringRec(e,g))}this.buf.b+="}"},toString:function(a,b){this.buf=new P;this.replacer=b;this.toStringRec("",a);return this.buf.b},__class__:r.Json};
r.Timer=function(a){var b=this;this.id=setInterval(function(){b.run()},a)};r.Timer.__name__=!0;r.Timer.delay=function(a,b){var c=new r.Timer(b);c.run=function(){c.stop();a()};return c};r.Timer.prototype={run:function(){console.log("run")},stop:function(){null!=this.id&&(clearInterval(this.id),this.id=null)},__class__:r.Timer};r.ds={};r.ds.StringMap=function(){};r.ds.StringMap.__name__=!0;r.ds.StringMap.__interfaces__=[U];r.ds.StringMap.prototype={keys:function(){var a=[],b;for(b in this.h)this.h.hasOwnProperty(b)&&
a.push(b.substr(1));return u.iter(a)},get:function(a){return this.h["$"+a]},__class__:r.ds.StringMap};var z={Boot:function(){}};z.Boot.__name__=!0;z.Boot.__string_rec=function(a,b){if(null==a)return"null";if(5<=b.length)return"<...>";var c=typeof a;if("function"==c&&(a.__name__||a.__ename__))c="object";switch(c){case "object":if(a instanceof Array){if(a.__enum__){if(2==a.length)return a[0];for(var c=a[0]+"(",b=b+"\t",f=2,e=a.length;f<e;)var g=f++,c=2!=g?c+(","+z.Boot.__string_rec(a[g],b)):c+z.Boot.__string_rec(a[g],
b);return c+")"}f=a.length;c="[";b+="\t";for(e=0;e<f;)g=e++,c+=(0<g?",":"")+z.Boot.__string_rec(a[g],b);return c+"]"}try{e=a.toString}catch(h){return"???"}if(null!=e&&e!=Object.toString&&(c=a.toString(),"[object Object]"!=c))return c;e=null;c="{\n";b+="\t";f=null!=a.hasOwnProperty;for(e in a)if(!f||a.hasOwnProperty(e))"prototype"==e||("__class__"==e||"__super__"==e||"__interfaces__"==e||"__properties__"==e)||(2!=c.length&&(c+=", \n"),c+=b+e+" : "+z.Boot.__string_rec(a[e],b));b=b.substring(1);return c+=
"\n"+b+"}";case "function":return"<function>";case "string":return a;default:return String(a)}};z.Boot.__interfLoop=function(a,b){if(null==a)return!1;if(a==b)return!0;var c=a.__interfaces__;if(null!=c)for(var f=0,e=c.length;f<e;){var g=f++,g=c[g];if(g==b||z.Boot.__interfLoop(g,b))return!0}return z.Boot.__interfLoop(a.__super__,b)};z.Boot.__instanceof=function(a,b){if(null==b)return!1;switch(b){case Y:return(a|0)===a;case V:return"number"==typeof a;case W:return"boolean"==typeof a;case String:return"string"==
typeof a;case Z:return!0;default:if(null!=a){if("function"==typeof b){if(a instanceof b)return b==Array?null==a.__enum__:!0;if(z.Boot.__interfLoop(a.__class__,b))return!0}}else return!1;return b==$&&null!=a.__name__||b==aa&&null!=a.__ename__?!0:a.__enum__==b}};z.Boot.__cast=function(a,b){if(z.Boot.__instanceof(a,b))return a;throw"Cannot cast "+i.string(a)+" to "+i.string(b);};var X=0;Array.prototype.indexOf&&(u.remove=function(a,b){var c=a.indexOf(b);if(-1==c)return!1;a.splice(c,1);return!0});Math.__name__=
["Math"];Math.NaN=Number.NaN;Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY;Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY;Math.isFinite=function(a){return isFinite(a)};Math.isNaN=function(a){return isNaN(a)};String.prototype.__class__=String;String.__name__=!0;Array.prototype.__class__=Array;Array.__name__=!0;var Y={__name__:["Int"]},Z={__name__:["Dynamic"]},V=Number;V.__name__=["Float"];var W=Boolean;W.__ename__=["Bool"];var $={__name__:["Class"]},aa={};"undefined"!=typeof JSON&&(r.Json=JSON);
n.errors=[];c.progs={zip:"zip"};h.queue=[];h.inProgress=!1;H.nameReg=new A("^[a-zA-Z]+[a-zA-Z0-9]*$","");p.nextPort=0;p.loaded=[];q.enumStr="__enum__.";C.actions={};D.main()})();
